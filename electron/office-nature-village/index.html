<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SpawnKit Village â€” Nature Kit</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:#1a2a14; overflow:hidden; font-family:'Press Start 2P',monospace; }
  canvas { display:block; cursor:grab; }
  canvas.dragging { cursor:grabbing; }

  #topbar {
    position:fixed; top:0; left:0; right:0; height:36px; z-index:100;
    background:rgba(20,30,15,0.95); border-bottom:2px solid #4a8; display:flex;
    align-items:center; padding:0 12px; gap:12px;
  }
  #topbar .title { color:#6d9; font-size:10px; letter-spacing:2px; }
  #topbar .mode { color:#fa5; font-size:7px; padding:2px 6px; border:1px solid #fa5; border-radius:3px; }
  #topbar .sep { flex:1; }
  #topbar .zoom-info { color:#8ab; font-size:7px; }

  #bottombar {
    position:fixed; bottom:0; left:0; right:0; min-height:32px; z-index:100;
    background:rgba(20,30,15,0.95); border-top:2px solid #4a8; display:flex;
    align-items:center; padding:0 8px; gap:10px; font-size:6px; color:#8ab;
    flex-wrap:wrap;
  }
  .agent-chip { display:flex; align-items:center; gap:4px; cursor:pointer; padding:2px 6px; border-radius:3px; }
  .agent-chip:hover { background:rgba(60,170,90,0.15); }
  .agent-chip .dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
  .agent-chip .aname { color:#cde; font-size:7px; }

  #agent-panel {
    position:fixed; top:36px; right:0; width:260px; bottom:32px; z-index:99;
    background:rgba(20,30,15,0.97); border-left:2px solid #4a8;
    transform:translateX(100%); transition:transform .3s ease;
    padding:16px; overflow-y:auto; color:#cde;
  }
  #agent-panel.open { transform:translateX(0); }
  #agent-panel h2 { font-size:10px; color:#6d9; margin-bottom:6px; }
  #agent-panel .role { font-size:7px; color:#fa5; margin-bottom:10px; }
  #agent-panel .field { font-size:7px; margin-bottom:5px; line-height:1.6; }
  #agent-panel .field label { color:#8ab; }
  #agent-panel .close-btn {
    position:absolute; top:8px; right:8px; background:none; border:1px solid #f55;
    color:#f55; font-size:8px; cursor:pointer; padding:2px 6px; font-family:inherit;
  }

  #loading {
    position:fixed; inset:0; z-index:200; background:#1a2a14; display:flex;
    flex-direction:column; align-items:center; justify-content:center; color:#6d9;
  }
  #loading .title { font-size:12px; margin-bottom:16px; }
  #loading .bar-wrap { width:200px; height:8px; border:1px solid #4a8; }
  #loading .bar-fill { height:100%; background:#4a8; width:0%; transition:width 0.2s; }
  #loading .pct { font-size:8px; margin-top:8px; color:#8ab; }
</style>
</head>
<body>

<div id="topbar">
  <span class="title">ğŸŒ¿ SPAWNKIT VILLAGE â€” NATURE KIT</span>
  <span class="mode">NATURE</span>
  <span class="sep"></span>
  <span id="zoom-info" class="zoom-info">100%</span>
</div>

<canvas id="game"></canvas>

<div id="bottombar"></div>

<div id="agent-panel">
  <button class="close-btn" onclick="document.getElementById('agent-panel').classList.remove('open')">âœ•</button>
  <h2 id="panel-name">â€”</h2>
  <div class="role" id="panel-role">â€”</div>
  <div class="field"><label>Status: </label><span id="panel-status">â€”</span></div>
  <div class="field"><label>Room: </label><span id="panel-room">â€”</span></div>
  <div class="field"><label>Task: </label><span id="panel-task">â€”</span></div>
</div>

<div id="loading">
  <div class="title">ğŸŒ¿ SPAWNKIT VILLAGE</div>
  <div class="bar-wrap"><div class="bar-fill" id="load-bar"></div></div>
  <div class="pct" id="load-pct">Loading...</div>
</div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TILE_W = 128;  // isometric tile width
const TILE_H = 64;   // isometric tile height
const MAP_W = 16;    // tiles wide
const MAP_H = 16;    // tiles tall
const CHAR_SCALE = 0.18; // character sprite scale relative to tile (512px source â†’ ~92px)
const FPS_ANIM = 6;

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ASSET LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let totalImages = 0, loadedCount = 0;

function loadImg(src) {
  totalImages++;
  const img = new Image();
  img.onload = () => { loadedCount++; updateLoadBar(); };
  img.onerror = () => { loadedCount++; updateLoadBar(); console.warn('Failed:', src); };
  img.src = src;
  return img;
}

function updateLoadBar() {
  const pct = Math.round((loadedCount / totalImages) * 100);
  document.getElementById('load-bar').style.width = pct + '%';
  document.getElementById('load-pct').textContent = pct + '% (' + loadedCount + '/' + totalImages + ')';
}

// Nature Kit terrain
const NK = {
  grass:     loadImg('assets/nature-kit/ground_grass_NE.png'),
  path:      loadImg('assets/nature-kit/ground_pathBend_NE.png'),
  pathStr:   loadImg('assets/nature-kit/ground_pathStraight_NE.png'),
  pathCross: loadImg('assets/nature-kit/ground_pathCross_NE.png'),
  pathCorner:loadImg('assets/nature-kit/ground_pathCorner_NE.png'),
  water:     loadImg('assets/nature-kit/cliff_waterfall_stone_NE.png'),
  waterFall: loadImg('assets/nature-kit/cliff_waterfallTop_stone_NE.png'),
  treePineA: loadImg('assets/nature-kit/tree_pineDefaultA_NE.png'),
  treePineB: loadImg('assets/nature-kit/tree_pineSmallA_NE.png'),
  treeOak:   loadImg('assets/nature-kit/tree_oak_NE.png'),
  treeDefault:loadImg('assets/nature-kit/tree_default_NE.png'),
  treeFall:  loadImg('assets/nature-kit/tree_default_fall_NE.png'),
  rockA:     loadImg('assets/nature-kit/rock_largeA_NE.png'),
  rockB:     loadImg('assets/nature-kit/rock_smallA_NE.png'),
  rockTall:  loadImg('assets/nature-kit/rock_tallA_NE.png'),
  flowerA:   loadImg('assets/nature-kit/flower_redA_NE.png'),
  flowerB:   loadImg('assets/nature-kit/flower_purpleA_NE.png'),
  flowerC:   loadImg('assets/nature-kit/flower_yellowA_NE.png'),
  campfire:  loadImg('assets/nature-kit/campfire_logs_NE.png'),
  tent:      loadImg('assets/nature-kit/tent_detailedOpen_NE.png'),
  tentSmall: loadImg('assets/nature-kit/tent_smallOpen_NE.png'),
  fenceA:    loadImg('assets/nature-kit/fence_simple_NE.png'),
  logStack:  loadImg('assets/nature-kit/log_stack_NE.png'),
  bench:     loadImg('assets/nature-kit/campfire_logs_NE.png'),
  bridge:    loadImg('assets/nature-kit/bridge_wood_NE.png'),
  bed:       loadImg('assets/nature-kit/bed_NE.png'),
  canoe:     loadImg('assets/nature-kit/canoe_paddle_NE.png'),
  mushroomA: loadImg('assets/nature-kit/mushroom_redGroup_NE.png'),
  mushroomB: loadImg('assets/nature-kit/mushroom_tanGroup_NE.png'),
  stump:     loadImg('assets/nature-kit/stump_round_NE.png'),
  signpost:  loadImg('assets/nature-kit/statue_column_NE.png'),
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHARACTER SPRITES (Blender-rendered Kenney Mini Characters)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CHAR_DEFS = [
  { id: 'apomac',   name: 'ApoMac',   role: 'CEO',     color: '#ffd700', model: 'character-male-a' },
  { id: 'forge',    name: 'Forge',     role: 'CTO',     color: '#7b68ee', model: 'character-male-c' },
  { id: 'hunter',   name: 'Hunter',    role: 'CRO',     color: '#ff6347', model: 'character-male-d' },
  { id: 'atlas',    name: 'Atlas',     role: 'COO',     color: '#20b2aa', model: 'character-male-e' },
  { id: 'echo',     name: 'Echo',      role: 'CMO',     color: '#dda0dd', model: 'character-female-a' },
  { id: 'sentinel', name: 'Sentinel',  role: 'Auditor', color: '#b0c4de', model: 'character-female-c' },
];

const DIRS = ['NE', 'NW', 'SE', 'SW'];
const FRAMES = 8;
const charSprites = {}; // charSprites[modelId][action][dir][frame] = img

for (const def of CHAR_DEFS) {
  if (charSprites[def.model]) continue;
  charSprites[def.model] = { idle: {}, walk: {} };
  for (const dir of DIRS) {
    charSprites[def.model].idle[dir] = [];
    charSprites[def.model].walk[dir] = [];
    for (let f = 0; f < FRAMES; f++) {
      const pad = String(f).padStart(3, '0');
      charSprites[def.model].idle[dir].push(
        loadImg(`assets/kenney-mini-characters/samples/${def.model}/idle_${def.model}/${dir}/frame_${pad}.png`)
      );
      charSprites[def.model].walk[dir].push(
        loadImg(`assets/kenney-mini-characters/samples/${def.model}/walk_${def.model}/${dir}/frame_${pad}.png`)
      );
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ISOMETRIC HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isoToScreen(tx, ty) {
  const x = (tx - ty) * (TILE_W / 2);
  const y = (tx + ty) * (TILE_H / 2);
  return { x, y };
}

function screenToIso(sx, sy) {
  const tx = (sx / (TILE_W / 2) + sy / (TILE_H / 2)) / 2;
  const ty = (sy / (TILE_H / 2) - sx / (TILE_W / 2)) / 2;
  return { tx, ty };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP LAYOUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 0=grass, 1=path, 2=water, 3=tree zone
const MAP = [];
for (let y = 0; y < MAP_H; y++) {
  MAP[y] = [];
  for (let x = 0; x < MAP_W; x++) {
    MAP[y][x] = 0; // default grass
  }
}

// Paths (cross-shaped through middle)
for (let i = 0; i < MAP_W; i++) { MAP[7][i] = 1; MAP[8][i] = 1; }
for (let i = 0; i < MAP_H; i++) { MAP[i][7] = 1; MAP[i][8] = 1; }

// Water (small pond bottom-right)
for (let y = 12; y < 15; y++) for (let x = 12; x < 15; x++) MAP[y][x] = 2;

// Decorations â€” placed on grass tiles
const DECORATIONS = [
  // Trees scattered around
  { tx:2, ty:2, img:'treePineA' }, { tx:3, ty:1, img:'treePineB' }, { tx:1, ty:4, img:'treeOak' },
  { tx:5, ty:2, img:'treeDefault' }, { tx:13, ty:1, img:'treePineA' }, { tx:14, ty:3, img:'treeFall' },
  { tx:1, ty:10, img:'treePineA' }, { tx:3, ty:12, img:'treeOak' }, { tx:2, ty:14, img:'treeDefault' },
  { tx:10, ty:2, img:'treePineB' }, { tx:12, ty:4, img:'treePineA' },
  { tx:14, ty:10, img:'treePineB' }, { tx:15, ty:12, img:'treeFall' },
  // Rocks
  { tx:5, ty:5, img:'rockA' }, { tx:10, ty:10, img:'rockB' }, { tx:0, ty:8, img:'rockTall' },
  // Flowers near paths
  { tx:6, ty:6, img:'flowerA' }, { tx:9, ty:6, img:'flowerB' }, { tx:6, ty:9, img:'flowerC' },
  { tx:9, ty:9, img:'flowerA' },
  // Camp area (top-right)
  { tx:11, ty:1, img:'campfire' }, { tx:12, ty:0, img:'tent' }, { tx:10, ty:0, img:'logStack' },
  // Village center
  { tx:6, ty:7, img:'bench' }, { tx:9, ty:8, img:'bench' },
  // Misc
  { tx:11, ty:13, img:'canoe' }, { tx:4, ty:13, img:'mushroomA' }, { tx:5, ty:14, img:'mushroomB' },
  { tx:0, ty:0, img:'stump' }, { tx:15, ty:15, img:'stump' },
  // Mission board (signpost at town center)
  { tx:7, ty:6, img:'signpost' },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AGENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const agents = CHAR_DEFS.map((def, i) => {
  // Spawn around center
  const positions = [
    {x:6,y:5}, {x:9,y:5}, {x:5,y:9}, {x:10,y:9}, {x:4,y:7}, {x:11,y:8}
  ];
  const pos = positions[i] || {x:7+i, y:7};
  return {
    ...def,
    x: pos.x, y: pos.y,
    targetX: pos.x, targetY: pos.y,
    homeX: pos.x, homeY: pos.y,
    action: 'idle',
    dir: DIRS[Math.floor(Math.random() * 4)],
    frame: Math.floor(Math.random() * FRAMES),
    animTimer: 0,
    speed: 1.0 + Math.random() * 0.5,
    status: 'idle',
    task: '',
    speechText: '',
    speechTimer: 0,
    wanderTimer: 3 + Math.random() * 5,
  };
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAMERA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let camX = 0, camY = 0, zoom = 1.0;
let dragging = false, dragStartX = 0, dragStartY = 0, camStartX = 0, camStartY = 0;

canvas.addEventListener('mousedown', e => {
  dragging = true; dragStartX = e.clientX; dragStartY = e.clientY;
  camStartX = camX; camStartY = camY; canvas.classList.add('dragging');
});
window.addEventListener('mousemove', e => {
  if (!dragging) return;
  camX = camStartX + (e.clientX - dragStartX);
  camY = camStartY + (e.clientY - dragStartY);
});
window.addEventListener('mouseup', () => { dragging = false; canvas.classList.remove('dragging'); });
canvas.addEventListener('wheel', e => {
  e.preventDefault();
  zoom = Math.max(0.3, Math.min(2.5, zoom - e.deltaY * 0.001));
  document.getElementById('zoom-info').textContent = Math.round(zoom * 100) + '%';
});

// Click to select agent
let selectedAgent = null;
canvas.addEventListener('click', e => {
  if (Math.abs(e.clientX - dragStartX) > 5) return; // was a drag
  const rect = canvas.getBoundingClientRect();
  const mx = (e.clientX - rect.left - camX - canvas.width/2) / zoom;
  const my = (e.clientY - rect.top - camY - canvas.height/2 + 100) / zoom;
  const iso = screenToIso(mx, my);

  selectedAgent = null;
  for (const a of agents) {
    const dist = Math.abs(a.x - iso.tx) + Math.abs(a.y - iso.ty);
    if (dist < 1.5) { selectedAgent = a; break; }
  }

  const panel = document.getElementById('agent-panel');
  if (selectedAgent) {
    panel.classList.add('open');
    document.getElementById('panel-name').textContent = selectedAgent.name;
    document.getElementById('panel-role').textContent = selectedAgent.role;
    document.getElementById('panel-status').textContent = selectedAgent.status;
    document.getElementById('panel-room').textContent = 'Village Square';
    document.getElementById('panel-task').textContent = selectedAgent.task || 'Idle';
  } else {
    panel.classList.remove('open');
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AGENT AI â€” Simple Wander
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SPEECH_LINES = [
  "Reviewing code...", "Checking metrics ğŸ“Š", "Deploying fix ğŸš€",
  "Need more coffee â˜•", "Meeting in 5...", "Looks good! âœ…",
  "Refactoring...", "On a call ğŸ“", "Brainstorming ğŸ’¡",
  "Writing tests...", "Lunch break ğŸ±", "Almost done!",
];

function updateAgent(a, dt) {
  // Animation
  a.animTimer += dt;
  if (a.animTimer >= 1 / FPS_ANIM) {
    a.animTimer -= 1 / FPS_ANIM;
    a.frame = (a.frame + 1) % FRAMES;
  }

  // Speech timer
  if (a.speechTimer > 0) a.speechTimer -= dt;

  // Wander
  a.wanderTimer -= dt;
  if (a.wanderTimer <= 0) {
    a.wanderTimer = 4 + Math.random() * 8;
    // Pick random walkable tile near center
    const nx = Math.floor(3 + Math.random() * 10);
    const ny = Math.floor(3 + Math.random() * 10);
    if (MAP[ny] && MAP[ny][nx] !== 2) { // not water
      a.targetX = nx; a.targetY = ny;
      a.action = 'walk';
      a.status = 'walking';
      // Trigger speech sometimes
      if (Math.random() < 0.3) {
        a.speechText = SPEECH_LINES[Math.floor(Math.random() * SPEECH_LINES.length)];
        a.speechTimer = 3;
      }
    }
  }

  // Move toward target
  const dx = a.targetX - a.x;
  const dy = a.targetY - a.y;
  const dist = Math.sqrt(dx*dx + dy*dy);

  if (dist > 0.1) {
    const step = Math.min(a.speed * dt, dist);
    a.x += (dx / dist) * step;
    a.y += (dy / dist) * step;

    // Determine iso direction
    if (Math.abs(dx) > Math.abs(dy)) {
      a.dir = dx > 0 ? 'SE' : 'NW';
    } else {
      a.dir = dy > 0 ? 'SW' : 'NE';
    }
    a.action = 'walk';
  } else {
    if (a.action === 'walk') {
      a.action = 'idle';
      a.status = 'idle';
      a.task = '';
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

// Center camera on map
const centerIso = isoToScreen(MAP_W/2, MAP_H/2);
camX = -centerIso.x * zoom;
camY = -centerIso.y * zoom + 100;

function drawTile(img, tx, ty, yOffset) {
  if (!img || !img.complete || !img.naturalWidth) return;
  const pos = isoToScreen(tx, ty);
  const w = TILE_W;
  const h = img.naturalHeight * (TILE_W / img.naturalWidth);
  ctx.drawImage(img, pos.x - w/2, pos.y - h + TILE_H/2 + (yOffset || 0), w, h);
}

function drawDecoration(dec) {
  const img = NK[dec.img];
  if (!img || !img.complete || !img.naturalWidth) return;
  const pos = isoToScreen(dec.tx, dec.ty);
  const w = TILE_W;
  const h = img.naturalHeight * (TILE_W / img.naturalWidth);
  ctx.drawImage(img, pos.x - w/2, pos.y - h + TILE_H/2, w, h);
}

function drawAgent(a) {
  const sprites = charSprites[a.model];
  if (!sprites) return;
  const actionSprites = sprites[a.action] || sprites.idle;
  const dirSprites = actionSprites[a.dir] || actionSprites['SE'];
  const frameImg = dirSprites[a.frame % dirSprites.length];
  if (!frameImg || !frameImg.complete) return;

  const pos = isoToScreen(a.x, a.y);
  const charH = TILE_H * 2.8;
  const charW = charH * (frameImg.naturalWidth / frameImg.naturalHeight);

  ctx.save();
  ctx.imageSmoothingEnabled = false;
  ctx.drawImage(frameImg, pos.x - charW/2, pos.y - charH + TILE_H/4, charW, charH);

  // Name label
  ctx.font = '7px "Press Start 2P"';
  ctx.textAlign = 'center';
  ctx.fillStyle = 'rgba(0,0,0,0.6)';
  ctx.fillText(a.name, pos.x + 1, pos.y - charH + TILE_H/4 - 7);
  ctx.fillStyle = a.color;
  ctx.fillText(a.name, pos.x, pos.y - charH + TILE_H/4 - 8);

  // Role badge
  ctx.font = '5px "Press Start 2P"';
  ctx.fillStyle = 'rgba(255,255,255,0.7)';
  ctx.fillText(a.role, pos.x, pos.y - charH + TILE_H/4 - 1);

  // Status plumbob
  const plY = pos.y - charH + TILE_H/4 - 18 + Math.sin(Date.now() / 400) * 3;
  ctx.fillStyle = a.status === 'idle' ? '#4f4' : '#ff4';
  ctx.beginPath();
  ctx.moveTo(pos.x, plY - 5); ctx.lineTo(pos.x + 4, plY); ctx.lineTo(pos.x, plY + 5); ctx.lineTo(pos.x - 4, plY); ctx.closePath();
  ctx.fill();

  // Speech bubble
  if (a.speechTimer > 0 && a.speechText) {
    const bx = pos.x;
    const by = pos.y - charH + TILE_H/4 - 30;
    ctx.font = '6px "Press Start 2P"';
    const tw = ctx.measureText(a.speechText).width;
    ctx.fillStyle = 'rgba(255,255,255,0.9)';
    const pad = 4;
    ctx.beginPath();
    ctx.roundRect(bx - tw/2 - pad, by - 8, tw + pad*2, 14, 4);
    ctx.fill();
    ctx.fillStyle = '#222';
    ctx.fillText(a.speechText, bx - tw/2, by);
  }

  ctx.restore();
}

// Selection highlight
function drawSelection(a) {
  const pos = isoToScreen(a.x, a.y);
  ctx.save();
  ctx.strokeStyle = '#6d9';
  ctx.lineWidth = 1.5;
  ctx.setLineDash([4,4]);
  ctx.beginPath();
  ctx.ellipse(pos.x, pos.y, TILE_W/3, TILE_H/4, 0, 0, Math.PI*2);
  ctx.stroke();
  ctx.restore();
}

let lastTime = 0;
function gameLoop(time) {
  const dt = Math.min((time - lastTime) / 1000, 0.1);
  lastTime = time;

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.save();
  ctx.translate(canvas.width/2 + camX, canvas.height/2 + camY - 100);
  ctx.scale(zoom, zoom);

  // Layer 1: Ground tiles
  for (let ty = 0; ty < MAP_H; ty++) {
    for (let tx = 0; tx < MAP_W; tx++) {
      const tile = MAP[ty][tx];
      if (tile === 2) drawTile(NK.water, tx, ty);
      else if (tile === 1) drawTile(NK.pathStr, tx, ty);
      else drawTile(NK.grass, tx, ty);
    }
  }

  // Collect renderables for Z-sort
  const renderables = [];

  // Decorations
  for (const dec of DECORATIONS) {
    renderables.push({ sortY: dec.tx + dec.ty, draw: () => drawDecoration(dec) });
  }

  // Update + collect agents
  for (const a of agents) {
    updateAgent(a, dt);
    renderables.push({ sortY: a.x + a.y, draw: () => drawAgent(a) });
  }

  // Z-sort and draw
  renderables.sort((a, b) => a.sortY - b.sortY);
  for (const r of renderables) r.draw();

  // Selection
  if (selectedAgent) drawSelection(selectedAgent);

  ctx.restore();
  requestAnimationFrame(gameLoop);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOTTOM BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateBottomBar() {
  const bar = document.getElementById('bottombar');
  bar.innerHTML = agents.map(a =>
    `<div class="agent-chip" onclick="selectAgent('${a.id}')">
      <div class="dot" style="background:${a.color}"></div>
      <span class="aname">${a.name}</span>
    </div>`
  ).join('');
}

window.selectAgent = function(id) {
  selectedAgent = agents.find(a => a.id === id) || null;
  const panel = document.getElementById('agent-panel');
  if (selectedAgent) {
    panel.classList.add('open');
    document.getElementById('panel-name').textContent = selectedAgent.name;
    document.getElementById('panel-role').textContent = selectedAgent.role;
    document.getElementById('panel-status').textContent = selectedAgent.status;
    document.getElementById('panel-room').textContent = 'Village Square';
    document.getElementById('panel-task').textContent = selectedAgent.task || 'Idle';
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function waitForLoad() {
  if (loadedCount >= totalImages && totalImages > 0) {
    document.getElementById('loading').style.display = 'none';
    updateBottomBar();
    console.log('[Nature Village] All', totalImages, 'assets loaded. Starting.');
    requestAnimationFrame(gameLoop);
  } else {
    requestAnimationFrame(waitForLoad);
  }
}
requestAnimationFrame(waitForLoad);

console.log('[Nature Village] Loading', totalImages, 'assets...');
</script>
</body>
</html>
