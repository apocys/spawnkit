<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FleetKit â€” Bureau Moderne</title>
<script>window.OC_RELAY_URL = window.OC_RELAY_URL || 'http://127.0.0.1:18790';</script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0a0c;overflow:hidden;font-family:'Inter',-apple-system,BlinkMacSystemFont,'SF Pro Text','Segoe UI',Roboto,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
canvas{display:block;image-rendering:pixelated;image-rendering:-moz-crisp-edges;image-rendering:crisp-edges;cursor:default}
#loading{position:fixed;inset:0;background:#0a0a0c;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;color:#AF52DE;font-size:13px;letter-spacing:-0.01em;transition:opacity .5s}
#loading h2{font-size:18px;margin-bottom:10px;color:#AF52DE;font-weight:700;letter-spacing:-0.02em}
#loading .bar{width:200px;height:4px;background:rgba(175,82,222,0.15);border-radius:980px;overflow:hidden;margin-top:8px}
#loading .fill{height:100%;background:linear-gradient(90deg,#AF52DE,#cba6f7);width:0%;transition:width .2s;border-radius:980px}
.hidden{opacity:0;pointer-events:none}
#tooltip{position:fixed;background:rgba(28,28,30,.92);backdrop-filter:saturate(180%) blur(20px);-webkit-backdrop-filter:saturate(180%) blur(20px);border:1px solid rgba(175,82,222,.2);border-radius:12px;padding:10px 14px;color:#f5f5f7;font:12px/1.5 'Inter',-apple-system,sans-serif;max-width:220px;z-index:200;display:none;pointer-events:none;box-shadow:0 8px 40px rgba(0,0,0,.4)}
#tooltip .nm{font-weight:600;font-size:14px;letter-spacing:-0.01em}
#tooltip .rl{color:#AF52DE;font-size:11px;font-weight:500}
#tooltip .tk{color:#86868b;font-size:11px;margin-top:3px}
#tooltip .st{font-size:11px;margin-top:2px;color:#30d158}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OVERLAY UI â€” iOS Branded
   Purple (#AF52DE) accent over dark surfaces
   Apple Arcade meets retro pixel art
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  /* iOS Brand Tokens â€” Dark Mode */
  --color-bg-primary: #000000;
  --color-bg-secondary: #1c1c1e;
  --color-bg-tertiary: #2c2c2e;
  --color-surface: #1c1c1e;
  --color-text-primary: #f5f5f7;
  --color-text-secondary: #86868b;
  --color-text-tertiary: #636366;
  --color-border: #38383a;
  --color-border-light: #2c2c2e;
  --color-accent: #AF52DE;
  --color-accent-hover: #BF6DE8;
  --color-accent-active: #9B3DC9;
  --color-accent-light: rgba(175, 82, 222, 0.12);
  --color-success: #30d158;
  --color-error: #ff453a;
  --color-warning: #ffd60a;
  --color-info: #64d2ff;

  /* Typography */
  --font-display: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
  --font-body: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, sans-serif;

  /* Shadows (Dark) */
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.3);
  --shadow-lg: 0 8px 40px rgba(0,0,0,0.4);

  /* Radius */
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;
  --radius-pill: 980px;

  /* Animation */
  --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
  --ease-spring: cubic-bezier(0.25, 1, 0.5, 1);
  --duration-fast: 150ms;
  --duration-normal: 300ms;

  /* Compatibility aliases for existing JS references */
  --cat-base: #1c1c1e;
  --cat-mantle: #141416;
  --cat-crust: #0a0a0c;
  --cat-surface0: #2c2c2e;
  --cat-surface1: #38383a;
  --cat-surface2: #48484a;
  --cat-overlay0: #636366;
  --cat-overlay1: #86868b;
  --cat-text: #f5f5f7;
  --cat-subtext0: #aeaeb2;
  --cat-subtext1: #c7c7cc;
  --cat-blue: #AF52DE;
  --cat-green: #30d158;
  --cat-pink: #ff375f;
  --cat-peach: #ff9f0a;
  --cat-yellow: #ffd60a;
  --cat-mauve: #BF5AF2;
  --cat-teal: #64d2ff;
  --cat-red: #ff453a;
  --cat-rosewater: #f5c2e7;
  --panel-width: 400px;
}

/* â”€â”€ Status Bar (Bottom) â€” Apple frosted glass â”€â”€â”€ */
.modern-statusbar {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  z-index: 50;
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 20px;
  background: rgba(28, 28, 30, 0.72);
  backdrop-filter: saturate(180%) blur(20px);
  -webkit-backdrop-filter: saturate(180%) blur(20px);
  border-top: 1px solid rgba(175, 82, 222, 0.12);
  font-family: var(--font-body);
}
.sb-info {
  display: flex; align-items: center; gap: 12px; flex-shrink: 0;
}
.sb-item {
  font-size: 12px; font-weight: 500; color: var(--color-text-secondary);
  display: flex; align-items: center; gap: 5px; white-space: nowrap;
  letter-spacing: -0.005em;
}
.sb-dot {
  width: 7px; height: 7px; border-radius: 50%; background: var(--color-success);
  animation: sbPulse 2.5s ease-in-out infinite;
}
@keyframes sbPulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
.sb-sep {
  width: 1px; height: 14px; background: rgba(175,82,222,0.12);
}
.sb-action {
  display: flex; align-items: center; gap: 5px;
  padding: 6px 14px; background: transparent;
  border: 1.5px solid rgba(175,82,222,0.2); border-radius: var(--radius-pill);
  cursor: pointer; font-family: var(--font-body);
  font-size: 12px; font-weight: 500; color: var(--color-text-secondary);
  transition: all var(--duration-fast) var(--ease-smooth); white-space: nowrap;
  letter-spacing: -0.005em;
}
.sb-action:hover {
  background: var(--color-accent-light); border-color: rgba(175,82,222,0.4);
  color: var(--color-text-primary);
}
.sb-action:focus-visible {
  outline: 2px solid var(--color-accent); outline-offset: 2px;
}
.sb-action-icon { font-size: 14px; }
.sb-cmd {
  flex: 1; position: relative;
}
.sb-cmd input {
  width: 100%; height: 36px; padding: 0 14px 0 32px;
  background: rgba(44, 44, 46, 0.6);
  border: 1.5px solid rgba(175,82,222,0.12); border-radius: var(--radius-pill);
  color: var(--color-text-primary); font-family: var(--font-body); font-size: 12px;
  outline: none; letter-spacing: -0.005em;
  transition: border-color var(--duration-fast), box-shadow var(--duration-fast);
}
.sb-cmd input::placeholder { color: var(--color-text-tertiary); }
.sb-cmd input:focus {
  border-color: var(--color-accent);
  box-shadow: 0 0 0 3px var(--color-accent-light);
}
.sb-cmd .sb-cmd-icon {
  position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
  color: var(--color-text-tertiary); font-size: 13px; pointer-events: none;
}

/* â”€â”€ Generic Slide-In Panel â€” Apple style â”€â”€â”€â”€â”€ */
.panel-overlay {
  position: fixed; inset: 0; z-index: 300;
  pointer-events: none; opacity: 0;
  transition: opacity var(--duration-normal) var(--ease-smooth);
}
.panel-overlay.open { pointer-events: auto; opacity: 1; }
.panel-overlay.open .panel-backdrop { opacity: 1; }
.panel-overlay.open .panel-slide { transform: translateX(0); }
.panel-backdrop {
  position: absolute; inset: 0;
  background: rgba(0,0,0,0.55); opacity: 0;
  transition: opacity 0.35s var(--ease-smooth);
}
.panel-slide {
  position: absolute; top: 0; right: 0;
  width: var(--panel-width); max-width: 90vw; height: 100%;
  background: var(--color-surface);
  border-left: 1px solid rgba(175,82,222,0.08);
  display: flex; flex-direction: column;
  transform: translateX(100%);
  transition: transform 0.4s var(--ease-spring);
  box-shadow: var(--shadow-lg);
  border-radius: var(--radius-lg) 0 0 var(--radius-lg);
}
.panel-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 18px 20px; border-bottom: 1px solid rgba(175,82,222,0.08);
  flex-shrink: 0;
}
.panel-title {
  font-size: 17px; font-weight: 600; color: var(--color-text-primary);
  display: flex; align-items: center; gap: 8px;
  letter-spacing: -0.015em;
}
.panel-close {
  width: 30px; height: 30px;
  display: flex; align-items: center; justify-content: center;
  border: none; background: var(--color-bg-tertiary); color: var(--color-text-secondary);
  border-radius: 50%; cursor: pointer; font-size: 15px;
  transition: all var(--duration-fast); font-family: var(--font-body);
}
.panel-close:hover { background: var(--cat-surface1); color: var(--color-text-primary); }
.panel-close:focus-visible { outline: 2px solid var(--color-accent); outline-offset: 2px; }
.panel-body {
  flex: 1; overflow-y: auto; padding: 0;
  scrollbar-width: thin; scrollbar-color: var(--cat-surface1) transparent;
}
.panel-body::-webkit-scrollbar { width: 4px; }
.panel-body::-webkit-scrollbar-thumb { background: var(--cat-surface1); border-radius: 2px; }
.panel-section {
  padding: 16px 20px; border-bottom: 1px solid rgba(175,82,222,0.06);
}
.panel-section:last-child { border-bottom: none; }
.panel-section-title {
  font-size: 11px; font-weight: 600; color: var(--color-text-secondary);
  text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 10px;
}

/* â”€â”€ Agent Detail Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.detail-hero {
  display: flex; align-items: center; gap: 14px;
  padding: 20px; border-bottom: 1px solid rgba(175,82,222,0.08);
}
.detail-hero-color {
  width: 52px; height: 52px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; font-weight: 700; color: #fff; flex-shrink: 0;
}
.detail-hero-info { flex: 1; min-width: 0; }
.detail-hero-name { font-size: 17px; font-weight: 700; color: var(--color-text-primary); letter-spacing: -0.015em; }
.detail-hero-role { font-size: 12px; color: var(--color-text-secondary); font-weight: 500; }
.detail-hero-task {
  font-size: 11px; color: var(--color-accent); margin-top: 3px; font-weight: 500;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.detail-metrics {
  display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
}
.detail-metric {
  padding: 12px; background: var(--color-bg-tertiary); border-radius: var(--radius-md);
}
.detail-metric-value {
  font-size: 15px; font-weight: 700; color: var(--color-text-primary);
}
.detail-metric-label {
  font-size: 10px; color: var(--color-text-secondary); margin-top: 2px;
}
.detail-todo-item {
  display: flex; align-items: center; gap: 8px;
  padding: 5px 0; font-size: 12px;
}
.detail-todo-icon { width: 16px; text-align: center; flex-shrink: 0; }
.detail-todo-text { flex: 1; color: var(--color-text-primary); line-height: 1.3; }
.detail-todo-item--done .detail-todo-text {
  color: var(--color-text-tertiary); text-decoration: line-through;
}
.detail-skill-chips {
  display: flex; flex-wrap: wrap; gap: 6px;
}
.detail-skill-chip {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 5px 12px; background: var(--color-accent-light);
  border-radius: var(--radius-pill); font-size: 11px; font-weight: 500; color: var(--color-accent);
}

/* â”€â”€ Chat Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chat-panel-slide {
  position: absolute; bottom: 0; right: 0;
  width: 460px; max-width: 100vw; height: 65vh;
  background: var(--color-surface);
  border-top-left-radius: var(--radius-xl);
  border-left: 1px solid rgba(175,82,222,0.08);
  border-top: 1px solid rgba(175,82,222,0.08);
  display: flex; flex-direction: column;
  transform: translateY(100%);
  transition: transform 0.4s var(--ease-spring);
  box-shadow: var(--shadow-lg);
}
.panel-overlay.open .chat-panel-slide { transform: translateY(0); }
.chat-messages {
  flex: 1; overflow-y: auto; padding: 14px 18px;
  display: flex; flex-direction: column; gap: 10px;
  scrollbar-width: thin; scrollbar-color: var(--cat-surface1) transparent;
}
.chat-messages::-webkit-scrollbar { width: 4px; }
.chat-messages::-webkit-scrollbar-thumb { background: var(--cat-surface1); border-radius: 2px; }
.chat-msg {
  max-width: 80%; padding: 10px 14px; border-radius: 16px;
  font-size: 13px; line-height: 1.47; letter-spacing: -0.005em;
  animation: chatIn 0.25s var(--ease-spring);
}
@keyframes chatIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}
.chat-msg--user {
  align-self: flex-end; background: var(--color-accent); color: #fff;
  border-bottom-right-radius: 4px;
}
.chat-msg--system {
  align-self: flex-start; background: var(--color-bg-tertiary); color: var(--color-text-primary);
  border-bottom-left-radius: 4px;
}
.chat-msg-time { font-size: 9px; opacity: 0.5; margin-top: 3px; }
.chat-msg--user .chat-msg-time { text-align: right; }
.chat-input-bar {
  display: flex; align-items: center; gap: 8px;
  padding: 12px 18px; border-top: 1px solid rgba(175,82,222,0.08);
  flex-shrink: 0;
}
.chat-input {
  flex: 1; height: 38px; padding: 0 16px;
  background: var(--color-bg-tertiary); border: 1.5px solid rgba(175,82,222,0.1);
  border-radius: var(--radius-pill); color: var(--color-text-primary);
  font-family: var(--font-body); font-size: 13px; outline: none;
  transition: border-color var(--duration-fast), box-shadow var(--duration-fast);
  letter-spacing: -0.005em;
}
.chat-input:focus {
  border-color: var(--color-accent);
  box-shadow: 0 0 0 3px var(--color-accent-light);
}
.chat-input::placeholder { color: var(--color-text-tertiary); }
.chat-send-btn {
  width: 38px; height: 38px;
  display: flex; align-items: center; justify-content: center;
  background: var(--color-accent); color: #fff;
  border: none; border-radius: 50%; cursor: pointer;
  font-size: 15px; transition: all var(--duration-fast); flex-shrink: 0;
}
.chat-send-btn:hover { background: var(--color-accent-hover); transform: scale(1.05); }
.chat-send-btn:active { transform: scale(0.95); }
.chat-empty {
  flex: 1; display: flex; align-items: center; justify-content: center;
  color: var(--color-text-tertiary); font-size: 13px; text-align: center; padding: 30px;
  letter-spacing: -0.005em;
}

/* â”€â”€ Cron / Mission Items â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cron-item {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 14px; background: var(--color-bg-tertiary);
  border-radius: var(--radius-md); margin-bottom: 6px;
  transition: background var(--duration-fast); font-size: 12px;
}
.cron-item:last-child { margin-bottom: 0; }
.cron-item:hover { background: var(--cat-surface1); }
.cron-item-icon { font-size: 18px; flex-shrink: 0; }
.cron-item-info { flex: 1; min-width: 0; }
.cron-item-name { font-size: 13px; font-weight: 600; color: var(--color-text-primary); letter-spacing: -0.01em; }
.cron-item-schedule { font-size: 11px; color: var(--color-text-secondary); margin-top: 2px; }
.cron-item-next { font-size: 11px; color: var(--color-accent); margin-top: 1px; }
.cron-item-status {
  display: inline-flex; align-items: center; justify-content: center;
  padding: 3px 10px; border-radius: var(--radius-pill);
  font-size: 9px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.06em; flex-shrink: 0;
}
.cron-item-status--active { background: rgba(48,209,88,0.12); color: var(--color-success); }
.cron-item-status--paused { background: rgba(255,214,10,0.12); color: var(--color-warning); }
.cron-item-status--error { background: rgba(255,69,58,0.12); color: var(--color-error); }
.cron-group-title {
  font-size: 11px; font-weight: 600; color: var(--color-text-secondary);
  text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 10px;
}

/* â”€â”€ Memory Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.memory-content-md {
  font-size: 13px; color: var(--color-text-secondary); line-height: 1.6;
  letter-spacing: -0.005em;
}
.memory-content-md h1,.memory-content-md h2,.memory-content-md h3 {
  color: var(--color-text-primary); margin: 12px 0 5px; font-weight: 600;
  letter-spacing: -0.015em;
}
.memory-content-md h1 { font-size: 17px; }
.memory-content-md h2 { font-size: 15px; }
.memory-content-md h3 { font-size: 13px; }
.memory-content-md ul,.memory-content-md ol { padding-left: 16px; margin: 5px 0; }
.memory-content-md li { margin: 2px 0; }
.memory-content-md strong { color: var(--color-text-primary); }
.memory-content-md code {
  background: var(--color-bg-tertiary); padding: 2px 6px; border-radius: 4px; font-size: 11px;
}
.memory-golden-rules {
  background: rgba(175,82,222,0.06); border: 1px solid rgba(175,82,222,0.15);
  border-radius: var(--radius-md); padding: 12px 14px; margin-bottom: 10px;
}
.memory-daily-item {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 12px; background: var(--color-bg-tertiary);
  border-radius: var(--radius-sm); font-size: 12px; color: var(--color-text-secondary);
  margin-bottom: 4px;
}
.memory-daily-item-date { font-weight: 600; color: var(--color-text-primary); min-width: 70px; }
.memory-daily-item-size { color: var(--color-text-tertiary); margin-left: auto; }
.memory-readonly {
  display: flex; align-items: center; gap: 5px;
  padding: 8px 14px; background: var(--color-accent-light);
  border-radius: var(--radius-sm); font-size: 11px; color: var(--color-accent); font-weight: 500;
  margin-top: 10px;
}

/* â”€â”€ Settings: API Keys â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.settings-mapping {
  display: grid; grid-template-columns: auto 20px auto;
  gap: 4px 10px; align-items: center; padding: 6px 0;
}
.settings-mapping-header {
  font-size: 10px; font-weight: 600; color: var(--color-text-secondary);
  text-transform: uppercase; letter-spacing: 0.06em;
}

/* â”€â”€ Toast â€” Apple notification style â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modern-toast {
  position: fixed; bottom: 70px; left: 50%;
  transform: translateX(-50%) translateY(16px);
  padding: 10px 20px; background: rgba(44,44,46,.92);
  backdrop-filter: saturate(180%) blur(20px);
  -webkit-backdrop-filter: saturate(180%) blur(20px);
  color: var(--color-text-primary); border-radius: var(--radius-pill); font-size: 13px;
  font-weight: 500; z-index: 999; font-family: var(--font-body);
  opacity: 0; transition: all var(--duration-normal) var(--ease-spring);
  pointer-events: none;
  box-shadow: var(--shadow-lg);
  border: 1px solid rgba(175,82,222,0.1);
  letter-spacing: -0.005em;
}
.modern-toast.show {
  opacity: 1; transform: translateX(-50%) translateY(0);
}

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 768px) {
  .modern-statusbar { flex-wrap: wrap; gap: 6px; padding: 8px 12px; }
  .sb-action { font-size: 11px; padding: 5px 10px; }
  .panel-slide { width: 100vw; border-radius: 0; }
  .chat-panel-slide { width: 100vw; height: 70vh; }
}
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    transition-duration: 0.01ms !important;
  }
}
</style>
</head>
<body>
<div id="loading"><h2>âš¡ FleetKit Bureau</h2><p id="lt">Chargementâ€¦</p><div class="bar"><div class="fill" id="bf"></div></div></div>
<canvas id="c"></canvas>
<div id="tooltip"></div>

<!-- â•â•â• Status Bar (Bottom) â•â•â• -->
<div class="modern-statusbar" role="status" aria-label="Office status bar">
  <div class="sb-info">
    <div class="sb-item"><span class="sb-dot" aria-hidden="true"></span><span>Bureau Moderne</span></div>
    <div class="sb-sep" aria-hidden="true"></div>
    <div class="sb-item"><span class="sb-action-icon" aria-hidden="true">ğŸ‘¥</span><span id="sbAgentCount">6 Agents</span></div>
    <div class="sb-sep" aria-hidden="true"></div>
    <div class="sb-item"><span class="sb-action-icon" aria-hidden="true">âš¡</span><span id="sbSystem">SystÃ¨mes nominaux</span></div>
  </div>
  <button class="sb-action" id="btnMissions" aria-label="Missions"><span class="sb-action-icon">ğŸ¯</span><span>Missions</span></button>
  <button class="sb-action" id="btnCrons" aria-label="Crons"><span class="sb-action-icon">ğŸ“…</span><span>Crons</span></button>
  <button class="sb-action" id="btnMemory" aria-label="MÃ©moire"><span class="sb-action-icon">ğŸ§ </span><span>MÃ©moire</span></button>
  <button class="sb-action" id="btnChat" aria-label="Chat"><span class="sb-action-icon">ğŸ’¬</span><span>Chat</span></button>
  <button class="sb-action" id="btnSettings" aria-label="ParamÃ¨tres"><span class="sb-action-icon">âš™ï¸</span><span>Config</span></button>
  <div class="sb-cmd">
    <input type="text" placeholder="Commande ou ğŸ’¬ pour discuter..." aria-label="Commande" id="cmdInput" autocomplete="off" spellcheck="false"/>
    <span class="sb-cmd-icon" aria-hidden="true">âŒ˜</span>
  </div>
</div>

<!-- â•â•â• Agent Detail Panel â•â•â• -->
<div class="panel-overlay" id="detailOverlay" role="dialog" aria-modal="true" aria-label="Agent Details">
  <div class="panel-backdrop" id="detailBackdrop"></div>
  <div class="panel-slide">
    <div class="detail-hero" id="detailHero"></div>
    <div class="panel-body" id="detailBody"></div>
  </div>
</div>

<!-- â•â•â• Chat Panel â•â•â• -->
<div class="panel-overlay" id="chatOverlay" role="dialog" aria-modal="true" aria-label="Chat">
  <div class="panel-backdrop" id="chatBackdrop"></div>
  <div class="chat-panel-slide">
    <div class="panel-header">
      <div class="panel-title"><span style="width:8px;height:8px;border-radius:50%;background:var(--cat-green);animation:sbPulse 2.5s ease-in-out infinite;"></span> CEO Chat</div>
      <button class="panel-close" id="chatClose" aria-label="Fermer">Ã—</button>
    </div>
    <div class="chat-messages" id="chatMessages"><div class="chat-empty" id="chatEmpty">Aucun message. Envoyez une mission au CEO.</div></div>
    <div class="chat-input-bar">
      <input class="chat-input" id="chatInput" type="text" placeholder="Envoyer une mission..." autocomplete="off" spellcheck="false"/>
      <button class="chat-send-btn" id="chatSendBtn" aria-label="Envoyer">â†‘</button>
    </div>
  </div>
</div>

<!-- â•â•â• Missions Panel â•â•â• -->
<div class="panel-overlay" id="missionsOverlay" role="dialog" aria-modal="true" aria-label="Missions">
  <div class="panel-backdrop" id="missionsBackdrop"></div>
  <div class="panel-slide">
    <div class="panel-header">
      <div class="panel-title"><span aria-hidden="true">ğŸ¯</span> Missions Actives</div>
      <button class="panel-close" id="missionsClose" aria-label="Fermer">Ã—</button>
    </div>
    <div class="panel-body" id="missionsBody"><div style="padding:30px;text-align:center;color:var(--cat-overlay0);font-size:12px;">Chargement des missionsâ€¦</div></div>
  </div>
</div>

<!-- â•â•â• Crons Panel â•â•â• -->
<div class="panel-overlay" id="cronsOverlay" role="dialog" aria-modal="true" aria-label="Cron Jobs">
  <div class="panel-backdrop" id="cronsBackdrop"></div>
  <div class="panel-slide">
    <div class="panel-header">
      <div class="panel-title"><span aria-hidden="true">ğŸ“…</span> TÃ¢ches PlanifiÃ©es</div>
      <button class="panel-close" id="cronsClose" aria-label="Fermer">Ã—</button>
    </div>
    <div class="panel-body" id="cronsBody"><div style="padding:30px;text-align:center;color:var(--cat-overlay0);font-size:12px;">Chargementâ€¦</div></div>
  </div>
</div>

<!-- â•â•â• Memory Panel â•â•â• -->
<div class="panel-overlay" id="memoryOverlay" role="dialog" aria-modal="true" aria-label="MÃ©moire">
  <div class="panel-backdrop" id="memoryBackdrop"></div>
  <div class="panel-slide" style="width:480px;">
    <div class="panel-header">
      <div class="panel-title"><span aria-hidden="true">ğŸ§ </span> MÃ©moire Fleet</div>
      <button class="panel-close" id="memoryClose" aria-label="Fermer">Ã—</button>
    </div>
    <div class="panel-body" id="memoryBody"><div style="padding:30px;text-align:center;color:var(--cat-overlay0);font-size:12px;">Chargementâ€¦</div></div>
  </div>
</div>

<!-- â•â•â• Settings Panel â•â•â• -->
<div class="panel-overlay" id="settingsOverlay" role="dialog" aria-modal="true" aria-label="ParamÃ¨tres">
  <div class="panel-backdrop" id="settingsBackdrop"></div>
  <div class="panel-slide" style="width:460px;">
    <div class="panel-header">
      <div class="panel-title"><span aria-hidden="true">âš™ï¸</span> ParamÃ¨tres</div>
      <button class="panel-close" id="settingsClose" aria-label="Fermer">Ã—</button>
    </div>
    <div class="panel-body" id="settingsBody"><div style="padding:30px;text-align:center;color:var(--cat-overlay0);font-size:12px;">Chargementâ€¦</div></div>
  </div>
</div>

<!-- â•â•â• Toast â•â•â• -->
<div class="modern-toast" id="modernToast"></div>

<script>
'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const T=32, S=1;
const COLS=30, ROWS=24;
const CW=COLS*T*S, CH=ROWS*T*S;
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');

function resize(){
  const sw=innerWidth,sh=innerHeight;
  const sc=Math.min(sw/CW,sh/CH);
  canvas.width=CW; canvas.height=CH;
  canvas.style.width=(CW*sc)+'px';
  canvas.style.height=(CH*sc)+'px';
  canvas.style.position='absolute';
  canvas.style.left=((sw-CW*sc)/2)+'px';
  canvas.style.top=((sh-CH*sc)/2)+'px';
}
resize(); addEventListener('resize',resize);
ctx.imageSmoothingEnabled=false;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPRITE LOADING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SP={};
const PATHS={
  rb:'../lib/sprites/modern-tiles-free/Modern tiles_Free/Interiors_free/32x32/Room_Builder_free_32x32.png',
  rbo:'../lib/sprites/modern-office-revamped/1_Room_Builder_Office/Room_Builder_Office_32x32.png',
  i:'../lib/sprites/modern-tiles-free/Modern tiles_Free/Interiors_free/32x32/Interiors_free_32x32.png',
  o:'../lib/sprites/modern-office-revamped/3_Modern_Office_Shadowless/Modern_Office_Shadowless_32x32.png',
  adam_i:'../lib/sprites/modern-tiles-free/Modern tiles_Free/Characters_free/Adam_idle_anim_16x16.png',
  adam_r:'../lib/sprites/modern-tiles-free/Modern tiles_Free/Characters_free/Adam_run_16x16.png',
  adam_s:'../lib/sprites/modern-tiles-free/Modern tiles_Free/Characters_free/Adam_sit_16x16.png',
  adam_p:'../lib/sprites/modern-tiles-free/Modern tiles_Free/Characters_free/Adam_phone_16x16.png',
  alex_i:'../lib/sprites/modern-tiles-free/Modern tiles_Free/Characters_free/Alex_idle_anim_16x16.png',
  alex_r:'../lib/sprites/modern-tiles-free/Modern tiles_Free/Characters_free/Alex_run_16x16.png',
  alex_s:'../lib/sprites/modern-tiles-free/Modern tiles_Free/Characters_free/Alex_sit_16x16.png',
  amelia_i:'../lib/sprites/modern-tiles-free/Modern tiles_Free/Characters_free/Amelia_idle_anim_16x16.png',
  amelia_r:'../lib/sprites/modern-tiles-free/Modern tiles_Free/Characters_free/Amelia_run_16x16.png',
  bob_i:'../lib/sprites/modern-tiles-free/Modern tiles_Free/Characters_free/Bob_idle_anim_16x16.png',
  bob_r:'../lib/sprites/modern-tiles-free/Modern tiles_Free/Characters_free/Bob_run_16x16.png',
  bob_s:'../lib/sprites/modern-tiles-free/Modern tiles_Free/Characters_free/Bob_sit_16x16.png',
};
let loaded=0; const total=Object.keys(PATHS).length;
const bf=document.getElementById('bf'),lt=document.getElementById('lt');
function loadAll(){return new Promise(ok=>{for(const[k,p]of Object.entries(PATHS)){const img=new Image();img.onload=()=>{SP[k]=img;dn()};img.onerror=()=>{console.warn('MISS:',k);dn()};img.src=p}function dn(){loaded++;bf.style.width=(loaded/total*100)+'%';lt.textContent=loaded+'/'+total;if(loaded>=total)ok()}})}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRAW HELPERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function dt(sheet,sc,sr,dx,dy){
  if(!sheet)return;
  ctx.drawImage(sheet, sc*T,sr*T, T,T, dx,dy, T,T);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROOM LAYOUT â€” Complete Redesign
   
   30Ã—24 tile grid. Thick walls everywhere.
   
   EXTERIOR WALLS:
     Top:    y=0-3 (4 rows: cap+face+face+baseboard/shadow)
     Left:   x=0 (1 col, baseboard tile)
     Right:  x=29 (1 col, baseboard tile)
     Bottom: y=22-23 (2 rows: cap+baseboard)
   
   VERTICAL INTERIOR WALLS (2 tiles wide each):
     Wall A: x=9-10 (between CEO & Workspace) â€” door at y=7-8
     Wall B: x=20-21 (between Workspace & Meeting) â€” door at y=7-8
     Wall C: x=9-10 (between Server & Reception) â€” door at y=17-18
     Wall D: x=20-21 (between Reception & Break) â€” door at y=17-18
   
   HORIZONTAL INTERIOR WALL:
     Mid-wall: y=12-14 (3 rows: cap+face+baseboard)
     Doorways at: x=4-5, x=14-15, x=25-26
   
   TOP ROOMS (y=4-11):
     CEO Office:    x=1-8
     Open Workspace: x=11-19
     Meeting Room:  x=22-28
   
   BOTTOM ROOMS (y=15-21):
     Server Room:   x=1-8
     Reception:     x=11-19
     Break Room:    x=22-28
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const FM=[];
for(let y=0;y<ROWS;y++){FM[y]=[];for(let x=0;x<COLS;x++)FM[y][x]=0}
function fill(x1,y1,x2,y2,v){for(let y=y1;y<=y2;y++)for(let x=x1;x<=x2;x++)if(y<ROWS&&x<COLS)FM[y][x]=v}

// Floor types:
// 1=blue-grey carpet, 2=warm wood, 3=purple carpet
// 4=cream tile, 5=dark concrete, 6=teal tile
fill(1,4,8,11,2);      // CEO office â€” warm wood
fill(11,4,19,11,1);     // Workspace â€” blue-grey carpet
fill(22,4,28,11,3);     // Meeting â€” purple carpet
fill(1,15,8,21,5);      // Server â€” dark concrete
fill(11,15,19,21,4);    // Reception â€” cream tile
fill(22,15,28,21,6);    // Break room â€” teal tile

function drawFloors(){
  const rb=SP.rb, rbo=SP.rbo;
  for(let y=0;y<ROWS;y++){
    for(let x=0;x<COLS;x++){
      const t=FM[y][x]; if(!t)continue;
      const cx=x%2, cy=y%2;
      if(t===1) { if(rb) dt(rb, 4+cx, 17+cy, x*T, y*T); }
      else if(t===2) { if(rb) dt(rb, cx, 7+cy, x*T, y*T); }
      else if(t===3) { if(rbo) dt(rbo, cx, 5+cy, x*T, y*T); }
      else if(t===4) { if(rb) dt(rb, cx, 19+cy, x*T, y*T); }
      else if(t===5) { if(rbo) dt(rbo, 10+(x%3), 7+cy, x*T, y*T); }
      else if(t===6) { if(rb) dt(rb, cx, 9+cy, x*T, y*T); }
    }
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WALL DRAWING â€” Thick solid walls
   
   Wall tiles (rb spritesheet):
     c14 r0 = cap (light grey, solid)
     c15 r0 = cap variant
     c16 r0 = cap variant
     c15 r1 = wall face (c14 r1 is transparent! Always use c15 or c16)
     c16 r1 = wall face variant
     c14 r2 = baseboard (light, solid)
     c15 r2 = baseboard variant
     c16 r2 = baseboard variant
     c14 r3 = shadow/floor transition
     c15 r3 = shadow variant
     c16 r3 = shadow variant
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function drawWalls(){
  const rb=SP.rb;
  if(!rb)return;
  
  // Wall face column (use c15 or c16, never c14 which is transparent at r1)
  const wf = (x) => 15 + (x%2);  // alternates c15, c16 for face
  const wc = (x) => 14 + (x%3);  // c14, c15, c16 for cap/baseboard
  
  // â•â•â• TOP EXTERIOR WALL (y=0-3) with windows â•â•â•
  const winPositions = new Set([3,4, 7,8, 12,13, 16,17, 23,24, 26,27]);
  for(let x=0; x<COLS; x++){
    dt(rb, wc(x), 0, x*T, 0);      // Row 0: Cap
    if(winPositions.has(x)){
      // Window: light blue pane with frame
      ctx.fillStyle='#b4d8e7';
      ctx.fillRect(x*T+2, T+2, T-4, T-4);
      ctx.fillRect(x*T+2, 2*T+2, T-4, T-4);
      // Window frame
      ctx.strokeStyle='#d0d0d5';
      ctx.lineWidth=1;
      ctx.strokeRect(x*T+2, T+2, T-4, 2*T-4);
      // Divider
      ctx.beginPath();
      ctx.moveTo(x*T+T/2, T+2);
      ctx.lineTo(x*T+T/2, 3*T-2);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x*T+2, 2*T);
      ctx.lineTo(x*T+T-2, 2*T);
      ctx.stroke();
      // Light spill from windows
      ctx.save();
      ctx.globalAlpha=0.04;
      ctx.fillStyle='#e8f4ff';
      ctx.fillRect(x*T-T/2, 3*T, T*2, 4*T);
      ctx.restore();
    } else {
      dt(rb, wf(x), 1, x*T, T);      // Row 1: Face (upper)
      dt(rb, wf(x), 1, x*T, 2*T);    // Row 2: Face (lower)
    }
    dt(rb, wc(x), 2, x*T, 3*T);    // Row 3: Baseboard
  }
  
  // â•â•â• LEFT EXTERIOR WALL (x=0) â•â•â•
  for(let y=4; y<22; y++){
    dt(rb, wc(y), 2, 0, y*T);
  }
  
  // â•â•â• RIGHT EXTERIOR WALL (x=29) â•â•â•
  for(let y=4; y<22; y++){
    dt(rb, wc(y), 2, 29*T, y*T);
  }
  
  // â•â•â• BOTTOM EXTERIOR WALL (y=22-23) â•â•â•
  for(let x=0; x<COLS; x++){
    dt(rb, wc(x), 0, x*T, 22*T);   // Cap
    dt(rb, wc(x), 2, x*T, 23*T);   // Baseboard
  }
  
  // â•â•â• VERTICAL INTERIOR WALLS â€” 2 tiles wide â•â•â•
  // These use the baseboard tile (c14-16 r2) which is fully opaque
  // Rendered as 2-column strips with solid fill behind
  
  function drawVertWall(x1, y1, y2, doorY1, doorY2){
    for(let y=y1; y<=y2; y++){
      if(doorY1!==undefined && y>=doorY1 && y<=doorY2) continue;
      // Left column: wall face side view (textured)
      dt(rb, wf(y), 1, x1*T, y*T);     // Wall face texture
      dt(rb, wc(y+1), 2, (x1+1)*T, y*T); // Baseboard texture
      // Add depth shadow on left edge
      ctx.fillStyle='rgba(0,0,0,0.08)';
      ctx.fillRect(x1*T, y*T, 3, T);
      // Add highlight on right edge
      ctx.fillStyle='rgba(255,255,255,0.06)';
      ctx.fillRect((x1+2)*T-3, y*T, 3, T);
    }
    // Top cap for vertical wall
    if(!(doorY1!==undefined && y1>=doorY1 && y1<=doorY2)){
      dt(rb, wc(x1), 0, x1*T, y1*T);
      dt(rb, wc(x1+1), 0, (x1+1)*T, y1*T);
    }
  }
  
  // Wall between CEO & Workspace: x=9-10, y=4-11, door at y=7-8
  drawVertWall(9, 4, 11, 7, 8);
  // Wall between Workspace & Meeting: x=20-21, y=4-11, door at y=7-8
  drawVertWall(20, 4, 11, 7, 8);
  // Wall between Server & Reception: x=9-10, y=15-21, door at y=17-18
  drawVertWall(9, 15, 21, 17, 18);
  // Wall between Reception & Break: x=20-21, y=15-21, door at y=17-18
  drawVertWall(20, 15, 21, 17, 18);
  
  // â•â•â• HORIZONTAL INTERIOR WALL (y=12-14) â•â•â•
  // 3 doorways: x=4-5, x=14-15, x=25-26
  for(let x=0; x<COLS; x++){
    const isDoor = (x>=4 && x<=5) || (x>=14 && x<=15) || (x>=25 && x<=26);
    if(isDoor){
      // Draw floor tiles under doorway
      const cy = x%2;
      if(x<=8){
        // Left section: wood floor
        if(rb){
          dt(rb, cy, 7, x*T, 12*T);
          dt(rb, cy, 8, x*T, 13*T);
          dt(rb, cy, 7, x*T, 14*T);
        }
      } else if(x<=21){
        // Center section: carpet
        if(rb){
          dt(rb, 4+cy, 17, x*T, 12*T);
          dt(rb, 4+cy, 18, x*T, 13*T);
          dt(rb, 4+cy, 17, x*T, 14*T);
        }
      } else {
        // Right section: purple carpet
        if(SP.rbo){
          dt(SP.rbo, cy, 5, x*T, 12*T);
          dt(SP.rbo, cy, 6, x*T, 13*T);
          dt(SP.rbo, cy, 5, x*T, 14*T);
        }
      }
    } else {
      dt(rb, wc(x), 0, x*T, 12*T);    // Cap
      dt(rb, wf(x), 1, x*T, 13*T);    // Face
      dt(rb, wc(x), 2, x*T, 14*T);    // Baseboard
    }
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AREA RUGS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function drawRugs(){
  ctx.save();
  
  ctx.globalAlpha=0.1;
  ctx.fillStyle='#fab387';
  ctx.fillRect(2*T, 5*T, 6*T, 6*T);   // CEO office
  
  ctx.globalAlpha=0.06;
  ctx.fillStyle='#89b4fa';
  ctx.fillRect(12*T, 5*T, 7*T, 6*T);  // Workspace
  
  ctx.globalAlpha=0.08;
  ctx.fillStyle='#94e2d5';
  ctx.fillRect(23*T, 6*T, 5*T, 5*T);  // Meeting
  
  ctx.globalAlpha=0.05;
  ctx.fillStyle='#f9e2af';
  ctx.fillRect(12*T, 16*T, 7*T, 5*T); // Reception
  
  ctx.globalAlpha=0.07;
  ctx.fillStyle='#a6e3a1';
  ctx.fillRect(23*T, 16*T, 5*T, 5*T); // Break room
  
  ctx.restore();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FURNITURE â€” Dense, room-by-room
   
   Verified coordinates from spritesheet analysis:
   
   o (Modern Office Shadowless 16cÃ—53r):
     Desk 3wÃ—4h: c0-2 r0-3 (wooden)
     Desk 2wÃ—4h: c0-1 r0-3 (subset)
     Monitor 2wÃ—2h: c0-1 r8-9 (dark screen)
     Monitor 2wÃ—2h: c2-3 r8-9 (variant)
     Filing cab 1wÃ—3h: c0-3 r40-42
   
   i (Interiors Free 16cÃ—89r):
     Plant 1wÃ—3h: c1 r0-2, c4 r0-2, c10 r0-2, c11 r0-2, c12 r0-2
     Conf table 4wÃ—2h: c1-4 r10-11
     Coffee table 2wÃ—2h: c6-7 r10-11
     Sofa 4wÃ—2h: c0-3 r26-27
     Bookshelf 2wÃ—2h: c0-1 r42-43, c2-3 r42-43, c4-5 r42-43
     Chairs 2wÃ—2h: c0-1 r44-45, c2-3 r44-45, c4-5 r44-45, c6-7 r44-45
     Chair variants: c0-1 r46-47, c2-3 r46-47
     Kitchen counter 3wÃ—2h: c0-2 r24-25
     Ceiling lamp 1Ã—1: c0-8 r33
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function drawFurniture(){
  const I=SP.i, O=SP.o;
  
  /* â”€â”€ CEO OFFICE (x=1-8, y=4-11) â€” Wood floor â”€â”€ */
  if(O){
    // Main CEO desk: 3wÃ—4h at x=3-5, y=6-9
    for(let c=0;c<3;c++){
      dt(O, c, 0, (3+c)*T, 6*T);
      dt(O, c, 1, (3+c)*T, 7*T);
      dt(O, c, 2, (3+c)*T, 8*T);
      dt(O, c, 3, (3+c)*T, 9*T);
    }
    // CEO monitor: 2wÃ—2h at x=3-4, y=5-6 (on desk surface)
    dt(O, 0, 8, 3*T, 5*T);
    dt(O, 1, 8, 4*T, 5*T);
    dt(O, 0, 9, 3*T, 6*T);
    dt(O, 1, 9, 4*T, 6*T);
    // Second monitor: x=5-6, y=5-6
    dt(O, 2, 8, 5*T, 5*T);
    dt(O, 3, 8, 6*T, 5*T);
    dt(O, 2, 9, 5*T, 6*T);
    dt(O, 3, 9, 6*T, 6*T);
    // Filing cabinet: x=1, y=6-8
    dt(O, 0, 40, 1*T, 6*T);
    dt(O, 0, 41, 1*T, 7*T);
    dt(O, 0, 42, 1*T, 8*T);
    // Filing cabinet: x=2, y=6-8
    dt(O, 1, 40, 2*T, 6*T);
    dt(O, 1, 41, 2*T, 7*T);
    dt(O, 1, 42, 2*T, 8*T);
  }
  if(I){
    // Bookshelf on wall: x=1-2, y=4-5
    dt(I, 0, 42, 1*T, 4*T);
    dt(I, 1, 42, 2*T, 4*T);
    dt(I, 0, 43, 1*T, 5*T);
    dt(I, 1, 43, 2*T, 5*T);
    // Bookshelf: x=7-8, y=4-5
    dt(I, 2, 42, 7*T, 4*T);
    dt(I, 3, 42, 8*T, 4*T);
    dt(I, 2, 43, 7*T, 5*T);
    dt(I, 3, 43, 8*T, 5*T);
    // Plant in corner: x=8, y=8-10
    dt(I, 1, 0, 8*T, 8*T);
    dt(I, 1, 1, 8*T, 9*T);
    dt(I, 1, 2, 8*T, 10*T);
    // Plant other corner: x=1, y=9-11
    dt(I, 4, 0, 1*T, 9*T);
    dt(I, 4, 1, 1*T, 10*T);
    dt(I, 4, 2, 1*T, 11*T);
    // Ceiling lamp
    dt(I, 0, 33, 4*T, 4*T);
    dt(I, 1, 33, 6*T, 4*T);
    // Chair (behind desk for CEO): x=4-5, y=10-11
    dt(I, 4, 46, 3*T, 10*T);
    dt(I, 5, 46, 4*T, 10*T);
    dt(I, 4, 47, 3*T, 11*T);
    dt(I, 5, 47, 4*T, 11*T);
    // Small decoration on desk
    dt(I, 10, 0, 6*T, 5*T);
  }
  
  /* â”€â”€ OPEN WORKSPACE (x=11-19, y=4-11) â€” Blue-grey carpet â”€â”€ */
  // 4 desk clusters in 2x2 layout
  drawDeskCluster(12, 5);  // top-left
  drawDeskCluster(16, 5);  // top-right
  drawDeskCluster(12, 8);  // bottom-left
  drawDeskCluster(16, 8);  // bottom-right
  
  if(I){
    // Ceiling lamps
    dt(I, 2, 33, 13*T, 4*T);
    dt(I, 3, 33, 17*T, 4*T);
    dt(I, 6, 33, 13*T, 7*T);
    dt(I, 8, 33, 17*T, 7*T);
    // Plant left edge: x=11, y=9-11
    dt(I, 4, 0, 11*T, 9*T);
    dt(I, 4, 1, 11*T, 10*T);
    dt(I, 4, 2, 11*T, 11*T);
    // Plant right edge: x=19, y=9-11
    dt(I, 1, 0, 19*T, 9*T);
    dt(I, 1, 1, 19*T, 10*T);
    dt(I, 1, 2, 19*T, 11*T);
    // Plant near entrance: x=11, y=4-6
    dt(I, 10, 0, 11*T, 4*T);
    dt(I, 10, 1, 11*T, 5*T);
    dt(I, 10, 2, 11*T, 6*T);
    // Tiny desk plants
    dt(I, 10, 0, 14*T, 4*T);
    dt(I, 10, 0, 18*T, 4*T);
  }
  
  /* â”€â”€ MEETING ROOM (x=22-28, y=4-11) â€” Purple carpet â”€â”€ */
  if(I){
    // Conference table: 4wÃ—2h at x=23-26, y=7-8
    for(let dx=0;dx<4;dx++){
      dt(I, 1+dx, 10, (23+dx)*T, 7*T);
      dt(I, 1+dx, 11, (23+dx)*T, 8*T);
    }
    // Chairs above table (facing down): y=5-6
    dt(I, 0, 44, 23*T, 5*T); dt(I, 1, 44, 24*T, 5*T);
    dt(I, 0, 45, 23*T, 6*T); dt(I, 1, 45, 24*T, 6*T);
    dt(I, 2, 44, 25*T, 5*T); dt(I, 3, 44, 26*T, 5*T);
    dt(I, 2, 45, 25*T, 6*T); dt(I, 3, 45, 26*T, 6*T);
    // Chairs below table (facing up): y=9-10
    dt(I, 4, 44, 23*T, 9*T); dt(I, 5, 44, 24*T, 9*T);
    dt(I, 4, 45, 23*T, 10*T); dt(I, 5, 45, 24*T, 10*T);
    dt(I, 6, 44, 25*T, 9*T); dt(I, 7, 44, 26*T, 9*T);
    dt(I, 6, 45, 25*T, 10*T); dt(I, 7, 45, 26*T, 10*T);
    // End chairs
    dt(I, 0, 46, 22*T, 7*T); dt(I, 1, 46, 22*T, 8*T);
    dt(I, 2, 46, 27*T, 7*T); dt(I, 3, 46, 27*T, 8*T);
    // Whiteboard/screen on wall: x=22-23, y=4-5
    if(O){
      dt(O, 0, 8, 22*T, 4*T); dt(O, 1, 8, 23*T, 4*T);
      dt(O, 0, 9, 22*T, 5*T); dt(O, 1, 9, 23*T, 5*T);
    }
    // Bookshelf: x=27-28, y=4-5
    dt(I, 4, 42, 27*T, 4*T); dt(I, 5, 42, 28*T, 4*T);
    dt(I, 4, 43, 27*T, 5*T); dt(I, 5, 43, 28*T, 5*T);
    // Plant: x=28, y=8-10
    dt(I, 12, 0, 28*T, 8*T);
    dt(I, 12, 1, 28*T, 9*T);
    dt(I, 12, 2, 28*T, 10*T);
    // Ceiling lamps
    dt(I, 0, 33, 24*T, 4*T);
    dt(I, 1, 33, 26*T, 4*T);
    // Lamp on table
    dt(I, 6, 33, 24*T, 7*T);
  }
  
  /* â”€â”€ SERVER ROOM (x=1-8, y=15-21) â€” Dark concrete â”€â”€ */
  if(O){
    // Filing cabinets row 1: x=1-7, y=15-17
    for(let cx=1; cx<=7; cx++){
      dt(O, (cx-1)%4, 40, cx*T, 15*T);
      dt(O, (cx-1)%4, 41, cx*T, 16*T);
      dt(O, (cx-1)%4, 42, cx*T, 17*T);
    }
    // Filing cabinets row 2: x=1-4, y=18-20
    for(let cx=1; cx<=4; cx++){
      dt(O, (cx-1)%4, 40, cx*T, 18*T);
      dt(O, (cx-1)%4, 41, cx*T, 19*T);
      dt(O, (cx-1)%4, 42, cx*T, 20*T);
    }
    // Monitoring desk: x=6-7, y=19-20
    dt(O, 0, 0, 6*T, 19*T); dt(O, 1, 0, 7*T, 19*T);
    dt(O, 0, 1, 6*T, 20*T); dt(O, 1, 1, 7*T, 20*T);
    // Monitor on desk: x=6-7, y=18-19
    dt(O, 0, 8, 6*T, 18*T); dt(O, 1, 8, 7*T, 18*T);
    dt(O, 0, 9, 6*T, 19*T); dt(O, 1, 9, 7*T, 19*T);
  }
  if(I){
    // Ceiling lamps
    dt(I, 8, 33, 3*T, 15*T);
    dt(I, 2, 33, 6*T, 15*T);
    // Small plant: x=8, y=19-21
    dt(I, 11, 0, 8*T, 19*T);
    dt(I, 11, 1, 8*T, 20*T);
    dt(I, 11, 2, 8*T, 21*T);
  }
  
  /* â”€â”€ RECEPTION / LOBBY (x=11-19, y=15-21) â€” Cream tile â”€â”€ */
  if(O){
    // Reception desk: 3wÃ—4h at x=14-16, y=16-19
    for(let c=0;c<3;c++){
      dt(O, c, 0, (14+c)*T, 16*T);
      dt(O, c, 1, (14+c)*T, 17*T);
      dt(O, c, 2, (14+c)*T, 18*T);
      dt(O, c, 3, (14+c)*T, 19*T);
    }
    // Monitor: x=14-15, y=15-16
    dt(O, 2, 8, 14*T, 15*T); dt(O, 3, 8, 15*T, 15*T);
    dt(O, 2, 9, 14*T, 16*T); dt(O, 3, 9, 15*T, 16*T);
  }
  if(I){
    // Waiting sofa: x=11-14, y=20-21
    dt(I, 0, 26, 11*T, 20*T); dt(I, 1, 26, 12*T, 20*T);
    dt(I, 2, 26, 13*T, 20*T); dt(I, 3, 26, 14*T, 20*T);
    dt(I, 0, 27, 11*T, 21*T); dt(I, 1, 27, 12*T, 21*T);
    dt(I, 2, 27, 13*T, 21*T); dt(I, 3, 27, 14*T, 21*T);
    // Chairs: x=17-18, y=20-21
    dt(I, 2, 44, 17*T, 20*T); dt(I, 3, 44, 18*T, 20*T);
    dt(I, 2, 45, 17*T, 21*T); dt(I, 3, 45, 18*T, 21*T);
    // Coffee table: x=15-16, y=20-21
    dt(I, 6, 10, 15*T, 20*T); dt(I, 7, 10, 16*T, 20*T);
    dt(I, 6, 11, 15*T, 21*T); dt(I, 7, 11, 16*T, 21*T);
    // Plants
    dt(I, 1, 0, 11*T, 15*T); dt(I, 1, 1, 11*T, 16*T); dt(I, 1, 2, 11*T, 17*T);
    dt(I, 4, 0, 19*T, 15*T); dt(I, 4, 1, 19*T, 16*T); dt(I, 4, 2, 19*T, 17*T);
    // Bookshelf: x=17-18, y=15-16
    dt(I, 0, 42, 17*T, 15*T); dt(I, 1, 42, 18*T, 15*T);
    dt(I, 0, 43, 17*T, 16*T); dt(I, 1, 43, 18*T, 16*T);
    // Ceiling lamps
    dt(I, 0, 33, 13*T, 15*T); dt(I, 3, 33, 16*T, 15*T);
    // Desk decoration
    dt(I, 10, 0, 16*T, 16*T);
  }
  
  /* â”€â”€ BREAK ROOM (x=22-28, y=15-21) â€” Teal tile â”€â”€ */
  if(I){
    // Kitchen counter: x=24-28, y=15-16
    for(let dx=0;dx<5;dx++){
      dt(I, dx%3, 24, (24+dx)*T, 15*T);
      dt(I, dx%3, 25, (24+dx)*T, 16*T);
    }
    // Sofa: x=22-25, y=19-20
    dt(I, 0, 26, 22*T, 19*T); dt(I, 1, 26, 23*T, 19*T);
    dt(I, 2, 26, 24*T, 19*T); dt(I, 3, 26, 25*T, 19*T);
    dt(I, 0, 27, 22*T, 20*T); dt(I, 1, 27, 23*T, 20*T);
    dt(I, 2, 27, 24*T, 20*T); dt(I, 3, 27, 25*T, 20*T);
    // Coffee table: x=23-24, y=17-18
    dt(I, 6, 10, 23*T, 17*T); dt(I, 7, 10, 24*T, 17*T);
    dt(I, 6, 11, 23*T, 18*T); dt(I, 7, 11, 24*T, 18*T);
    // Armchair: x=26-27, y=18-19
    dt(I, 0, 46, 26*T, 18*T); dt(I, 1, 46, 27*T, 18*T);
    dt(I, 0, 47, 26*T, 19*T); dt(I, 1, 47, 27*T, 19*T);
    // Plants
    dt(I, 12, 0, 22*T, 15*T); dt(I, 12, 1, 22*T, 16*T); dt(I, 12, 2, 22*T, 17*T);
    dt(I, 1, 0, 28*T, 18*T); dt(I, 1, 1, 28*T, 19*T); dt(I, 1, 2, 28*T, 20*T);
    // Ceiling lamps
    dt(I, 6, 33, 25*T, 15*T); dt(I, 2, 33, 27*T, 15*T);
    // Extra small table: x=22, y=17
    dt(I, 10, 0, 22*T, 18*T);
    // Bookshelf on side: x=26-27, y=15-16
    dt(I, 2, 42, 22*T, 21*T); dt(I, 3, 42, 23*T, 21*T);
  }
  
  /* â”€â”€ EXTRA FURNITURE â€” density push for SS+ â”€â”€ */
  ctx.save();
  
  // Water cooler (reception) â€” blue bottle on grey stand
  ctx.fillStyle='#6c7086';
  ctx.fillRect(19*T+4,17*T,T-8,T*2);
  ctx.fillStyle='#89b4fa';
  ctx.fillRect(19*T+8,16*T+12,T-16,T-4);
  ctx.globalAlpha=0.3;ctx.fillStyle='#fff';
  ctx.fillRect(19*T+12,16*T+14,4,8);
  ctx.globalAlpha=1;
  
  // Whiteboard filled (meeting room) â€” with colored post-its and lines
  ctx.fillStyle='#e8e8ee';
  ctx.fillRect(24*T,4*T+4,4*T,T*2-8);
  ctx.strokeStyle='#b0b0b8';ctx.lineWidth=1;
  ctx.strokeRect(24*T,4*T+4,4*T,T*2-8);
  // Post-it clusters on whiteboard
  [[24.2,4.3,'#f38ba8'],[24.8,4.3,'#f9e2af'],[25.4,4.3,'#a6e3a1'],
   [24.2,5,'#89b4fa'],[24.8,5,'#cba6f7'],[25.4,5,'#94e2d5'],
   [26,4.3,'#f5c2e7'],[26.6,4.3,'#fab387'],[26,5,'#a6e3a1']].forEach(([px,py,c])=>{
    ctx.fillStyle=c;ctx.globalAlpha=0.8;
    ctx.fillRect(px*T,py*T,12,10);
    ctx.globalAlpha=0.3;ctx.fillStyle='#333';
    ctx.fillRect(px*T+2,py*T+3,8,1);
    ctx.fillRect(px*T+2,py*T+5,6,1);
  });
  ctx.globalAlpha=1;
  // Whiteboard header line
  ctx.fillStyle='#333';ctx.font='bold 5px sans-serif';ctx.textAlign='left';
  ctx.globalAlpha=0.4;ctx.fillText('SPRINT 4',24*T+4,4*T+12);ctx.globalAlpha=1;
  
  // Printer (near workspace) x=19, y=11
  ctx.fillStyle='#585b70';
  ctx.fillRect(19*T+2,11*T+6,T-4,T-8);
  ctx.fillStyle='#45475a';
  ctx.fillRect(19*T+4,11*T+2,T-8,6);
  // Paper tray
  ctx.fillStyle='#e8e8ee';
  ctx.fillRect(19*T+6,11*T+T-4,T-12,3);
  
  // Coat rack (near entrance) x=11, y=15
  ctx.fillStyle='#6c5030';
  ctx.fillRect(10*T+14,15*T+4,3,T-8);
  ctx.fillStyle='#45475a';
  ctx.fillRect(10*T+10,15*T+4,10,3);
  // Hanging coat
  ctx.fillStyle='#313244';ctx.globalAlpha=0.6;
  ctx.fillRect(10*T+10,15*T+7,4,10);
  ctx.globalAlpha=1;
  
  // Trash cans (small dark circles)
  ctx.fillStyle='#45475a';
  [[8,11],[19,4],[28,21],[1,21]].forEach(([tx,ty])=>{
    ctx.beginPath();ctx.arc(tx*T+T/2,ty*T+T/2,5,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#313244';
    ctx.beginPath();ctx.arc(tx*T+T/2,ty*T+T/2,3,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#45475a';
  });
  
  // Extra monitors on workspace desks (small bright rectangles)
  ctx.fillStyle='#313244';
  [[13,4],[17,4],[13,7],[17,7]].forEach(([mx,my])=>{
    // Monitor body
    ctx.fillRect(mx*T+2,my*T+2,T-4,T-8);
    // Screen glow
    ctx.fillStyle='#1e1e3e';
    ctx.fillRect(mx*T+4,my*T+3,T-8,T-12);
    ctx.fillStyle='#313244';
    // Stand
    ctx.fillRect(mx*T+12,my*T+T-6,8,4);
    ctx.fillRect(mx*T+14,my*T+T-3,4,3);
  });
  
  // Project board (wall near CEO) â€” kanban style
  ctx.fillStyle='#1e1e2e';
  ctx.fillRect(7*T+2,4*T+8,T*2-4,T*2-12);
  ctx.strokeStyle='rgba(137,180,250,0.3)';ctx.lineWidth=0.5;
  ctx.strokeRect(7*T+2,4*T+8,T*2-4,T*2-12);
  // Kanban columns
  ctx.fillStyle='rgba(137,180,250,0.15)';
  ctx.fillRect(7*T+4,4*T+10,18,T*2-16);
  ctx.fillStyle='rgba(249,226,175,0.15)';
  ctx.fillRect(7*T+24,4*T+10,18,T*2-16);
  ctx.fillStyle='rgba(166,227,161,0.15)';
  ctx.fillRect(7*T+44,4*T+10,16,T*2-16);
  
  ctx.restore();
  
  /* â”€â”€ DESK DETAILS â€” sticky notes, papers, cables â”€â”€ */
  ctx.save();
  // Sticky notes (small colored squares on desk surfaces)
  const stickies=[
    {x:5,y:6,c:'#f9e2af'},{x:6,y:7,c:'#f38ba8'},{x:13,y:5,c:'#89b4fa'},
    {x:17,y:5,c:'#a6e3a1'},{x:14,y:8,c:'#cba6f7'},{x:18,y:8,c:'#f9e2af'},
    {x:15,y:17,c:'#89b4fa'},{x:7,y:19,c:'#a6e3a1'}
  ];
  stickies.forEach(s=>{
    ctx.globalAlpha=0.7;
    ctx.fillStyle=s.c;
    ctx.fillRect(s.x*T+4,s.y*T+4,7,7);
    // Tiny text line
    ctx.globalAlpha=0.3;
    ctx.fillStyle='#333';
    ctx.fillRect(s.x*T+5,s.y*T+6,5,1);
    ctx.fillRect(s.x*T+5,s.y*T+8,4,1);
  });
  // Paper stacks (thin white rectangles)
  ctx.globalAlpha=0.5;
  ctx.fillStyle='#e8e8ee';
  [[4,6],[7,7],[16,5],[25,7],[15,16]].forEach(([px,py])=>{
    ctx.fillRect(px*T+8,py*T+2,10,6);
    ctx.fillRect(px*T+9,py*T+1,10,6);
  });
  // Coffee mugs (tiny circles)
  ctx.globalAlpha=0.6;
  [[6,6,'#94e2d5'],[14,5,'#f5c2e7'],[18,5,'#89b4fa'],[24,8,'#fab387']].forEach(([mx,my,mc])=>{
    ctx.fillStyle=mc;
    ctx.beginPath();ctx.arc(mx*T+6,my*T+6,3,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#1e1e2e';
    ctx.beginPath();ctx.arc(mx*T+6,my*T+6,1.5,0,Math.PI*2);ctx.fill();
  });
  ctx.restore();
  
  /* â”€â”€ WALL DECORATIONS (on top exterior wall face + between windows) â”€â”€ */
  if(O){
    // Wall-mounted flat screens (between window pairs)
    dt(O, 0, 8, 10*T, T); dt(O, 1, 8, 11*T, T);
    dt(O, 0, 9, 10*T, 2*T); dt(O, 1, 9, 11*T, 2*T);
    dt(O, 2, 8, 20*T, T); dt(O, 3, 8, 21*T, T);
    dt(O, 2, 9, 20*T, 2*T); dt(O, 3, 9, 21*T, 2*T);
  }
  if(I){
    // Hanging bookshelves on solid wall sections
    dt(I, 4, 42, 1*T, T); dt(I, 5, 42, 2*T, T);
    dt(I, 4, 43, 1*T, 2*T); dt(I, 5, 43, 2*T, 2*T);
    dt(I, 0, 42, 5*T, T); dt(I, 1, 42, 6*T, T);
    dt(I, 0, 43, 5*T, 2*T); dt(I, 1, 43, 6*T, 2*T);
    // Ceiling lamps on wall sections
    dt(I, 2, 33, 15*T, 2*T);
    dt(I, 6, 33, 19*T, 2*T);
    dt(I, 3, 33, 25*T, 2*T);
    dt(I, 8, 33, 28*T, 2*T);
  }
  
  /* â”€â”€ FLOOR DETAILS (entry mats, rugs in doorways) â”€â”€ */
  ctx.save();
  // Doorway floor mats (subtle brown rectangles)
  ctx.globalAlpha=0.15;
  ctx.fillStyle='#8b7355';
  // Mid-wall doorways
  [4,14,25].forEach(dx=>{
    ctx.fillRect(dx*T, 13*T+4, 2*T, T-8);
  });
  ctx.restore();
  
  /* â”€â”€ WALL CLOCKS (on mid-wall face) â”€â”€ */
  ctx.save();
  // Small clocks on mid-horizontal wall
  [[8,12.3],[19,12.3],[28,12.3]].forEach(([cx,cy])=>{
    ctx.beginPath();
    ctx.arc(cx*T, cy*T, 5, 0, Math.PI*2);
    ctx.fillStyle='#fff';
    ctx.fill();
    ctx.strokeStyle='#555';
    ctx.lineWidth=1;
    ctx.stroke();
    // Clock hands
    const h=new Date().getHours()%12, m=new Date().getMinutes();
    const ha=((h+m/60)/12)*Math.PI*2-Math.PI/2;
    const ma=(m/60)*Math.PI*2-Math.PI/2;
    ctx.beginPath();
    ctx.moveTo(cx*T, cy*T);
    ctx.lineTo(cx*T+Math.cos(ha)*3, cy*T+Math.sin(ha)*3);
    ctx.strokeStyle='#333'; ctx.lineWidth=1.5; ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(cx*T, cy*T);
    ctx.lineTo(cx*T+Math.cos(ma)*4, cy*T+Math.sin(ma)*4);
    ctx.strokeStyle='#666'; ctx.lineWidth=1; ctx.stroke();
  });
  ctx.restore();
}

/* â”€â”€ Desk cluster helper (3w wide desk with monitor + chair) â”€â”€ */
function drawDeskCluster(bx, by){
  const O=SP.o, I=SP.i;
  if(!O) return;
  // 3wÃ—3h desk (wider, more like ref)
  for(let c=0;c<3;c++){
    dt(O, c, 0, (bx+c)*T, by*T);
    dt(O, c, 1, (bx+c)*T, (by+1)*T);
    dt(O, c, 2, (bx+c)*T, (by+2)*T);
  }
  // Monitor centered on desk
  dt(O, 0, 8, (bx)*T, (by-1)*T); dt(O, 1, 8, (bx+1)*T, (by-1)*T);
  // Small items on desk surface (mug, papers)
  if(I){
    dt(I, 10, 0, (bx+2)*T, (by-1)*T); // tiny plant/mug
  }
  // Chair behind desk
  if(I){
    dt(I, 0, 44, (bx)*T, (by+3)*T); dt(I, 1, 44, (bx+1)*T, (by+3)*T);
    dt(I, 0, 45, (bx)*T, (by+4)*T); dt(I, 1, 45, (bx+1)*T, (by+4)*T);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AMBIENT EFFECTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PARTICLES â€” Dust motes, coffee steam, sparkles
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const particles=[];
function spawnParticle(x,y,type){
  particles.push({x,y,type,life:1,vx:(Math.random()-0.5)*0.3,vy:-Math.random()*0.5-0.1,age:0});
}
function updateParticles(){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx;p.y+=p.vy;p.age++;
    p.life=1-p.age/(p.type==='dust'?120:p.type==='steam'?80:60);
    if(p.life<=0)particles.splice(i,1);
  }
}
function drawParticles(){
  ctx.save();
  for(const p of particles){
    if(p.type==='dust'){
      ctx.globalAlpha=p.life*0.15;
      ctx.fillStyle='#fff8e7';
      ctx.fillRect(p.x,p.y,2,2);
    }else if(p.type==='steam'){
      ctx.globalAlpha=p.life*0.25;
      ctx.fillStyle='#e0e0e0';
      ctx.beginPath();ctx.arc(p.x,p.y,2+p.age*0.05,0,Math.PI*2);ctx.fill();
    }
  }
  ctx.restore();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPEECH BUBBLES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const speechMessages={
  'ApoMac':['Revenue target...','Ship it!','Think different','Board meeting prep'],
  'Forge':['Refactoring...','PR review','Deploying...','Bug squashed ğŸ›'],
  'Hunter':['New lead found','Cold outreach','Pipeline +1','Closing deal...'],
  'Atlas':['Systems nominal','Ops check âœ“','SLA: 99.9%','Scaling up'],
  'Echo':['Campaign live!','CTR +12%','Content draft','Brand refresh'],
  'Sentinel':['Audit clean âœ…','Scanning...','Vuln patched','All clear']
};
const bubbles=[];
function spawnBubble(agent){
  const msgs=speechMessages[agent.name]||['...'];
  const text=msgs[Math.floor(Math.random()*msgs.length)];
  bubbles.push({agent,text,life:180,maxLife:180});
}
function drawBubbles(){
  ctx.save();
  for(let i=bubbles.length-1;i>=0;i--){
    const b=bubbles[i];
    b.life--;
    if(b.life<=0){bubbles.splice(i,1);continue;}
    const alpha=b.life<30?b.life/30:b.life>150?(180-b.life)/30:1;
    const bx=Math.round(b.agent.x*T);
    const by=Math.round(b.agent.y*T-FH*2-12);
    ctx.globalAlpha=alpha*0.92;
    ctx.font='7px "Segoe UI",sans-serif';
    const tw=ctx.measureText(b.text).width;
    const pw=tw+10,ph=14;
    // Bubble bg
    ctx.fillStyle='rgba(30,30,46,0.88)';
    ctx.beginPath();
    ctx.moveTo(bx-pw/2+3,by-ph);ctx.lineTo(bx+pw/2-3,by-ph);
    ctx.quadraticCurveTo(bx+pw/2,by-ph,bx+pw/2,by-ph+3);
    ctx.lineTo(bx+pw/2,by-3);ctx.quadraticCurveTo(bx+pw/2,by,bx+pw/2-3,by);
    ctx.lineTo(bx+3,by);ctx.lineTo(bx,by+5);ctx.lineTo(bx-3,by);
    ctx.lineTo(bx-pw/2+3,by);ctx.quadraticCurveTo(bx-pw/2,by,bx-pw/2,by-3);
    ctx.lineTo(bx-pw/2,by-ph+3);ctx.quadraticCurveTo(bx-pw/2,by-ph,bx-pw/2+3,by-ph);
    ctx.fill();
    ctx.strokeStyle='rgba(137,180,250,0.3)';ctx.lineWidth=0.5;ctx.stroke();
    // Text
    ctx.fillStyle='#cdd6f4';ctx.textAlign='center';
    ctx.fillText(b.text,bx,by-4);
  }
  ctx.restore();
}

function drawAmbient(tick){
  ctx.save();
  
  // Warm ceiling light pools with visible cones
  ctx.globalAlpha=0.08;
  [[4,7],[13,6],[17,6],[24,7],[4,18],[13,18],[16,18],[25,18]].forEach(([lx,ly])=>{
    const cx=lx*T, cy=ly*T;
    const grad=ctx.createRadialGradient(cx,cy,0,cx,cy,3.5*T);
    grad.addColorStop(0,'rgba(255,251,230,0.25)');
    grad.addColorStop(0.5,'rgba(255,251,230,0.08)');
    grad.addColorStop(1,'rgba(255,251,230,0)');
    ctx.fillStyle=grad;
    ctx.fillRect(cx-4*T,cy-4*T,8*T,8*T);
  });
  
  // Subtle floor reflections on tiled areas (reception + break room)
  ctx.globalAlpha=0.03;
  ctx.fillStyle='rgba(255,255,255,0.5)';
  for(let x=11;x<=19;x+=2)for(let y=15;y<=21;y+=2){
    ctx.fillRect(x*T+4,y*T+T-3,T-8,2);
  }
  for(let x=22;x<=28;x+=2)for(let y=15;y<=21;y+=2){
    ctx.fillRect(x*T+4,y*T+T-3,T-8,2);
  }
  
  // Monitor glow â€” enhanced pulsing
  const pulse = 0.4 + 0.15 * Math.sin(tick * 0.04);
  ctx.globalAlpha=pulse * 0.15;
  ctx.fillStyle='#89b4fa';
  ctx.fillRect(14*T, T, 2*T, 2*T);
  ctx.fillRect(24*T, T, 2*T, 2*T);
  [[12,4],[16,4],[12,7],[16,7]].forEach(([mx,my])=>{
    ctx.fillRect(mx*T, my*T, 2*T, T);
  });
  ctx.fillRect(3*T, 5*T, 2*T, T);
  ctx.fillRect(14*T, 15*T, 2*T, T);
  ctx.fillRect(6*T, 18*T, 2*T, T);
  
  // Server LED blinks â€” enhanced with glow halos
  const leds=[
    {x:1,y:15,p:0},{x:2,y:16,p:1.5},{x:3,y:15,p:3},
    {x:4,y:16,p:0.7},{x:5,y:15,p:2.2},{x:6,y:16,p:4.1},
    {x:7,y:15,p:1.3},{x:1,y:17,p:1},{x:3,y:17,p:2.5},
    {x:5,y:17,p:3.8},{x:7,y:17,p:0.5},
    {x:1,y:18,p:2.1},{x:2,y:19,p:0.3},{x:3,y:18,p:1.8},
    {x:4,y:19,p:2.7},{x:1,y:20,p:4.5},{x:3,y:20,p:0.9}
  ];
  leds.forEach(l=>{
    if(Math.sin(tick*0.1+l.p)>0){
      const col=Math.sin(l.p*2)>0?'#a6e3a1':'#f38ba8';
      // LED dot
      ctx.globalAlpha=0.9;
      ctx.fillStyle=col;
      ctx.fillRect(l.x*T+12,l.y*T+14,4,4);
      ctx.fillRect(l.x*T+20,l.y*T+8,4,4);
      // Glow halo
      ctx.globalAlpha=0.08;
      ctx.beginPath();ctx.arc(l.x*T+14,l.y*T+16,8,0,Math.PI*2);
      ctx.fillStyle=col;ctx.fill();
    }
  });
  
  // Break room warmth â€” enhanced
  ctx.globalAlpha=0.06;
  const wg=ctx.createRadialGradient(25*T,18*T,0,25*T,18*T,5*T);
  wg.addColorStop(0,'rgba(250,179,135,0.2)');
  wg.addColorStop(1,'rgba(250,179,135,0)');
  ctx.fillStyle=wg;
  ctx.fillRect(21*T,14*T,8*T,8*T);
  
  // Spawn dust motes in light pools
  if(tick%30===0){
    [[4,7],[13,6],[17,6],[24,7]].forEach(([lx,ly])=>{
      if(Math.random()>0.5)spawnParticle(lx*T+(Math.random()-0.5)*3*T,ly*T+(Math.random()-0.5)*3*T,'dust');
    });
  }
  // Coffee steam in break room
  if(tick%15===0){
    spawnParticle(25*T+Math.random()*T,16*T,'steam');
  }
  
  ctx.restore();
  
  // Particles on top
  updateParticles();
  drawParticles();
  
  // Speech bubbles â€” spawn randomly
  if(tick%300===0){
    const a=agents[Math.floor(Math.random()*agents.length)];
    if(!bubbles.find(b=>b.agent===a))spawnBubble(a);
  }
  drawBubbles();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROOM LABELS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function drawLabels(){
  ctx.save();
  ctx.font='bold 8px "Courier New",monospace';
  ctx.textAlign='center';
  [[' CEO ',5*T,11.5*T],['OPEN SPACE',15*T,11.5*T],['RÃ‰UNION',25*T,11.5*T],
   ['SERVEURS',5*T,21.5*T],['ACCUEIL',15*T,21.5*T],['DÃ‰TENTE',25*T,21.5*T]]
  .forEach(([t,x,y])=>{
    ctx.fillStyle='rgba(0,0,0,0.5)';
    ctx.fillText(t,x+1,y+1);
    ctx.fillStyle='rgba(205,214,244,0.35)';
    ctx.fillText(t,x,y);
  });
  ctx.restore();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHARACTERS
   
   Character placement rules:
   - 16Ã—32 sprite drawn at 2Ã— = 32Ã—64 pixels (1 tile wide, 2 tiles tall)
   - Anchor (a.x, a.y) is FEET position in tile coords
   - dy = y*T - FH*2 + 8, so body extends ~56px ABOVE anchor
   
   For SITTING at desks (facing UP):
   - Desk occupies e.g. y=6-9 (top of desk at y=6)
   - Character sits at y=10 (feet at row 10, body at rows 8-10)
   - This puts character body overlapping desk bottom rows
   - The desk front panel (r2-3) will overlap the character's lower body
   - The character's head+torso are visible above the desk surface
   
   For SITTING, we draw desks first, then chars, so char is ON TOP of desk.
   Actually we want desk to partially cover the character:
   We draw furniture BEFORE characters, so characters overlap furniture.
   For sitting chars, position carefully so head is fully visible.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const FW=16, FH=32, FPD=6;
const DIR={d:0,u:1,r:2,l:3};

const agents=[
  {name:'ApoMac',role:'CEO',color:'#fab387',
   idle:'adam_i',run:'adam_r',sit:'adam_s',
   x:4.5, y:10, dir:DIR.u, state:'sit',
   homeX:4.5, homeY:10, homeState:'sit', homeDir:DIR.u,
   task:'Planification stratÃ©gique', status:'Actif', tint:null,
   routine:{active:false,timer:0,interval:90*60,phase:'home',
     destPath:[{x:4.5,y:10},{x:4.5,y:13},{x:14.5,y:13},{x:24,y:13},{x:24,y:8}],
     returnPath:[{x:24,y:8},{x:24,y:13},{x:14.5,y:13},{x:4.5,y:13},{x:4.5,y:10}],
     stayTime:30*60}},
  {name:'Forge',role:'CTO',color:'#cba6f7',
   idle:'alex_i',run:'alex_r',sit:'alex_s',
   x:13, y:8, dir:DIR.u, state:'sit',
   homeX:13, homeY:8, homeState:'sit', homeDir:DIR.u,
   task:'Revue de code', status:'Actif', tint:null,
   routine:{active:false,timer:0,interval:75*60,phase:'home',
     destPath:[{x:13,y:8},{x:14.5,y:13},{x:25,y:13},{x:25,y:18}],
     returnPath:[{x:25,y:18},{x:25,y:13},{x:14.5,y:13},{x:13,y:8}],
     stayTime:25*60}},
  {name:'Hunter',role:'CRO',color:'#f38ba8',
   idle:'amelia_i',run:'amelia_r',
   x:15, y:13, dir:DIR.r, state:'walk',
   homeX:15, homeY:13, homeState:'walk', homeDir:DIR.r,
   task:'Prospection clients', status:'En dÃ©placement', tint:null,
   path:[
     {x:14.5,y:13},{x:14.5,y:8},{x:14.5,y:5},{x:18,y:5},
     {x:18,y:8},{x:18,y:11},{x:14.5,y:11},{x:14.5,y:13},
     {x:14.5,y:17},{x:14.5,y:20},{x:11,y:20},
     {x:5,y:20},{x:5,y:17},{x:5,y:13},{x:14.5,y:13}
   ],
   pi:0,pp:0,routine:null},
  {name:'Atlas',role:'COO',color:'#94e2d5',
   idle:'bob_i',run:'bob_r',sit:'bob_s',
   x:17, y:8, dir:DIR.u, state:'sit',
   homeX:17, homeY:8, homeState:'sit', homeDir:DIR.u,
   task:'Analyse opÃ©rationnelle', status:'Actif', tint:null,
   routine:null},
  {name:'Echo',role:'CMO',color:'#f9e2af',
   idle:'adam_i',run:'adam_r',phone:'adam_p',
   x:18.5, y:6, dir:DIR.d, state:'phone',
   homeX:18.5, homeY:6, homeState:'phone', homeDir:DIR.d,
   task:'Campagne marketing', status:'Au tÃ©lÃ©phone',
   tint:[249,226,175],
   routine:null},
  {name:'Sentinel',role:'Auditeur',color:'#a6e3a1',
   idle:'alex_i',run:'alex_r',
   x:7, y:20, dir:DIR.u, state:'idle',
   homeX:7, homeY:20, homeState:'idle', homeDir:DIR.u,
   task:'Surveillance systÃ¨me', status:'Monitoring',
   tint:[166,227,161],
   routine:null},
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TINT SYSTEM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TC=new Map();
function tinted(img,t){
  if(!t||!img)return img;
  const k=img.src+t;if(TC.has(k))return TC.get(k);
  const c=document.createElement('canvas');c.width=img.width;c.height=img.height;
  const cx=c.getContext('2d');cx.drawImage(img,0,0);
  cx.globalCompositeOperation='source-atop';
  cx.fillStyle=`rgba(${t[0]},${t[1]},${t[2]},0.25)`;
  cx.fillRect(0,0,c.width,c.height);TC.set(k,c);return c;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANIMATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let tick=0, af=0; const AS=10;

function drawChar(a){
  let sheet,fi;
  if(a.state==='walk'||a.state==='routine_walk'){
    sheet=SP[a.run]; fi=a.dir*FPD+(af%FPD);
  } else if(a.state==='sit'&&a.sit){
    sheet=SP[a.sit]; fi=a.dir*FPD+(af%FPD);
  } else if(a.state==='phone'&&a.phone){
    sheet=SP[a.phone]; fi=af%(sheet?Math.floor(sheet.width/FW):6);
  } else {
    sheet=SP[a.idle]; fi=a.dir*FPD+(af%FPD);
  }
  if(!sheet)return;
  if(a.tint)sheet=tinted(sheet,a.tint);
  
  const dx=Math.round(a.x*T-FW);
  const dy=Math.round(a.y*T-FH*2+8);
  
  // Shadow under agent
  ctx.save();
  ctx.globalAlpha=0.18;
  ctx.fillStyle='#000';
  ctx.beginPath();
  ctx.ellipse(Math.round(a.x*T),Math.round(a.y*T+2),12,5,0,0,Math.PI*2);
  ctx.fill();
  ctx.restore();
  
  ctx.drawImage(sheet, fi*FW,0, FW,FH, dx,dy, FW*2,FH*2);
  
  // Name tag
  const lx=Math.round(a.x*T);
  const ly=dy-6;
  ctx.font='bold 9px "Segoe UI",sans-serif';
  ctx.textAlign='center';
  ctx.fillStyle='rgba(0,0,0,0.7)';
  ctx.fillText(a.name,lx+1,ly+1);
  ctx.fillStyle=a.color;
  ctx.fillText(a.name,lx,ly);
  
  // Status dot
  const tw=ctx.measureText(a.name).width;
  ctx.beginPath();
  ctx.arc(lx+tw/2+6,ly-3,2.5,0,Math.PI*2);
  ctx.fillStyle=a.state==='walk'||a.state==='routine_walk'?'#f9e2af':
                a.state==='phone'?'#89b4fa':'#a6e3a1';
  ctx.fill();
}

function updateWalker(a){
  if(!a.path)return;
  a.pp+=0.02;
  if(a.pp>=1){a.pp=0;a.pi=(a.pi+1)%a.path.length}
  const c=a.path[a.pi],n=a.path[(a.pi+1)%a.path.length];
  a.x=c.x+(n.x-c.x)*a.pp; a.y=c.y+(n.y-c.y)*a.pp;
  const ddx=n.x-c.x,ddy=n.y-c.y;
  if(Math.abs(ddx)>Math.abs(ddy))a.dir=ddx>0?DIR.r:DIR.l;
  else if(Math.abs(ddy)>0)a.dir=ddy>0?DIR.d:DIR.u;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROUTINE SYSTEM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateRoutine(a){
  if(!a.routine)return;
  const r=a.routine;
  r.timer++;
  if(r.phase==='home'){
    if(r.timer>=r.interval){
      r.phase='going';r.timer=0;
      a.state='routine_walk';
      a._routePath=r.destPath;a._routeIdx=0;a._routeProg=0;
      a.status='En dÃ©placement';
    }
  } else if(r.phase==='going'){
    a._routeProg+=0.02;
    if(a._routeProg>=1){
      a._routeProg=0;a._routeIdx++;
      if(a._routeIdx>=a._routePath.length-1){
        r.phase='away';r.timer=0;
        a.state='idle';a.status='En pause';
        const d=a._routePath[a._routePath.length-1];
        a.x=d.x;a.y=d.y;a.dir=DIR.d;
        return;
      }
    }
    const c=a._routePath[a._routeIdx],n=a._routePath[a._routeIdx+1];
    a.x=c.x+(n.x-c.x)*a._routeProg;
    a.y=c.y+(n.y-c.y)*a._routeProg;
    const ddx=n.x-c.x,ddy=n.y-c.y;
    if(Math.abs(ddx)>Math.abs(ddy))a.dir=ddx>0?DIR.r:DIR.l;
    else if(Math.abs(ddy)>0)a.dir=ddy>0?DIR.d:DIR.u;
  } else if(r.phase==='away'){
    if(r.timer>=r.stayTime){
      r.phase='returning';r.timer=0;
      a.state='routine_walk';
      a._routePath=r.returnPath;a._routeIdx=0;a._routeProg=0;
      a.status='Retour au poste';
    }
  } else if(r.phase==='returning'){
    a._routeProg+=0.02;
    if(a._routeProg>=1){
      a._routeProg=0;a._routeIdx++;
      if(a._routeIdx>=a._routePath.length-1){
        r.phase='home';r.timer=0;
        a.x=a.homeX;a.y=a.homeY;
        a.state=a.homeState;a.dir=a.homeDir;
        a.status='Actif';
        return;
      }
    }
    const c=a._routePath[a._routeIdx],n=a._routePath[a._routeIdx+1];
    a.x=c.x+(n.x-c.x)*a._routeProg;
    a.y=c.y+(n.y-c.y)*a._routeProg;
    const ddx=n.x-c.x,ddy=n.y-c.y;
    if(Math.abs(ddx)>Math.abs(ddy))a.dir=ddx>0?DIR.r:DIR.l;
    else if(Math.abs(ddy)>0)a.dir=ddy>0?DIR.d:DIR.u;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HUD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function drawHUD(){
  const now=new Date();
  const ts=now.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
  ctx.fillStyle='rgba(30,30,46,0.92)';
  ctx.fillRect(0,0,CW,24);
  ctx.fillStyle='rgba(137,180,250,0.15)';
  ctx.fillRect(0,23,CW,1);
  ctx.font='bold 10px "Segoe UI",sans-serif';
  ctx.textAlign='left';
  ctx.fillStyle='#cba6f7';
  ctx.fillText('âš¡ FleetKit Bureau Moderne',8,15);
  ctx.fillStyle='#89b4fa';
  const active=agents.filter(a=>a.state!=='idle').length;
  ctx.fillText(`ğŸ‘¥ ${agents.length} agents Â· ${active} actifs`,180,15);
  ctx.fillStyle='#a6e3a1';
  ctx.fillText(`âš¡ Tous systÃ¨mes nominaux`,320,15);
  ctx.textAlign='right';
  ctx.fillStyle='#f9e2af';
  ctx.fillText(`ğŸ• ${ts}`,CW-8,15);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOOLTIP
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const tip=document.getElementById('tooltip');
canvas.addEventListener('mousemove',e=>{
  const r=canvas.getBoundingClientRect();
  const mx=(e.clientX-r.left)/r.width*COLS*T;
  const my=(e.clientY-r.top)/r.height*ROWS*T;
  let found=null;
  for(const a of agents){
    const ax=a.x*T-FW, ay=a.y*T-FH*2+8;
    if(mx>=ax&&mx<=ax+FW*2&&my>=ay&&my<=ay+FH*2){found=a;break}
  }
  if(found){
    canvas.style.cursor='pointer';
    tip.style.display='block';
    tip.style.left=(e.clientX+12)+'px';
    tip.style.top=(e.clientY-10)+'px';
    tip.innerHTML=`<div class="nm" style="color:${found.color}">${found.name}</div>
      <div class="rl">${found.role}</div>
      <div class="tk">ğŸ“‹ ${found.task}</div>
      <div class="st">â— ${found.status}</div>`;
  }else{
    canvas.style.cursor='default';
    tip.style.display='none';
  }
});
canvas.addEventListener('mouseleave',()=>{
  tip.style.display='none';
  canvas.style.cursor='default';
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA BRIDGE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
addEventListener('message',e=>{
  if(e.data?.type==='fleetkit:getState')postState();
  if(e.data?.type==='fleetkit:update'&&e.data.agents){
    for(const u of e.data.agents){
      const a=agents.find(x=>x.name===u.name);
      if(a){if(u.task)a.task=u.task;if(u.status)a.status=u.status;}
    }
  }
});
function postState(){
  parent.postMessage({
    type:'fleetkit:state',
    agents:agents.map(a=>({
      name:a.name,role:a.role,color:a.color,
      x:a.x,y:a.y,state:a.state,
      task:a.task,status:a.status
    })),
    meta:{theme:'office-modern',agents:agents.length,tasks:agents.length}
  },'*');
}
setInterval(postState,5000);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER LOOP
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function render(){
  tick++;
  if(tick%AS===0) af++;
  
  ctx.clearRect(0,0,CW,CH);
  // Darker building exterior (not pure void)
  ctx.fillStyle='#232030';
  ctx.fillRect(0,0,CW,CH);
  // Subtle exterior ground below building
  ctx.fillStyle='#2a2738';
  ctx.fillRect(0,22*T,CW,2*T);
  
  drawFloors();
  drawRugs();
  drawWalls();
  drawFurniture();
  drawLabels();
  drawAmbient(tick);
  
  for(const a of agents){
    if(a.state==='walk') updateWalker(a);
    updateRoutine(a);
  }
  
  [...agents].sort((a,b)=>a.y-b.y).forEach(drawChar);
  drawHUD();
  requestAnimationFrame(render);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
loadAll().then(()=>{
  document.getElementById('loading').classList.add('hidden');
  setTimeout(()=>document.getElementById('loading').style.display='none',600);
  console.log('âœ… Office-Modern v3.2 â€” 3-iteration polish');
  console.log('   - Fixed direction mapping (l/r were swapped)');
  console.log('   - Windows on top wall with light spill');
  console.log('   - Textured vertical walls with depth shadows');
  console.log('   - Wall clocks, floor mats, desk items');
  console.log('   - Wider desk clusters (3w), chairs behind desks');
  render();
});
</script>

<!-- â•â•â• Data Bridge â•â•â• -->
<script>
    window.OC_RELAY_URL = 'http://127.0.0.1:18790';
    window.OC_RELAY_TOKEN = 'sk-oc-proxy-spawnkit-2026';
</script>
<script src="../src/data-bridge.js"></script>

<!-- â•â•â• Overlay UI: Panels, Data Bridge, Agent Click â•â•â• -->
<script>
(function() {
'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   spawnkitAPI reference
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var API = (typeof window.spawnkitAPI !== 'undefined') ? window.spawnkitAPI : null;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Agent Data (mirrors canvas agents array)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var AGENTS_DATA = {
  apomac:   { name:'ApoMac',   role:'CEO',       color:'#fab387', status:'active', task:'Planification stratÃ©gique' },
  forge:    { name:'Forge',    role:'CTO',       color:'#cba6f7', status:'active', task:'Revue de code' },
  hunter:   { name:'Hunter',   role:'CRO',       color:'#f38ba8', status:'active', task:'Prospection clients' },
  atlas:    { name:'Atlas',    role:'COO',       color:'#94e2d5', status:'active', task:'Analyse opÃ©rationnelle' },
  echo:     { name:'Echo',     role:'CMO',       color:'#f9e2af', status:'active', task:'Campagne marketing' },
  sentinel: { name:'Sentinel', role:'Auditeur',  color:'#a6e3a1', status:'active', task:'Surveillance systÃ¨me' }
};

var LIVE_AGENT_DATA = {};
var liveCronData = null;
var liveMemoryData = null;
var chatHistory = [];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Toast
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showToast(msg) {
  var t = document.getElementById('modernToast');
  if (!t) return;
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._timer);
  t._timer = setTimeout(function() { t.classList.remove('show'); }, 2500);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Panel Helpers
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openPanel(id) {
  closeAllPanels();
  document.getElementById(id).classList.add('open');
}
function closePanel(id) {
  document.getElementById(id).classList.remove('open');
}

var PANEL_IDS = ['detailOverlay','chatOverlay','missionsOverlay','cronsOverlay','memoryOverlay','settingsOverlay'];
function closeAllPanels() {
  PANEL_IDS.forEach(function(id) { document.getElementById(id).classList.remove('open'); });
}

// Wire backdrop + close buttons
PANEL_IDS.forEach(function(id) {
  var el = document.getElementById(id);
  var backdrop = el.querySelector('.panel-backdrop');
  var close = el.querySelector('.panel-close');
  if (backdrop) backdrop.addEventListener('click', function() { closePanel(id); });
  if (close) close.addEventListener('click', function() { closePanel(id); });
});

// Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeAllPanels();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Status Bar: Clock
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateSBClock() {
  var now = new Date();
  var h = now.getHours().toString().padStart(2,'0');
  var m = now.getMinutes().toString().padStart(2,'0');
  var el = document.getElementById('sbSystem');
  if (el) el.textContent = 'SystÃ¨mes nominaux Â· ' + h + ':' + m;
}
updateSBClock();
setInterval(updateSBClock, 30000);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Status Bar: Action Buttons
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.getElementById('btnMissions').addEventListener('click', function() { openPanel('missionsOverlay'); renderMissions(); });
document.getElementById('btnCrons').addEventListener('click', function() { openPanel('cronsOverlay'); renderCrons(); });
document.getElementById('btnMemory').addEventListener('click', function() { openPanel('memoryOverlay'); renderMemory(); });
document.getElementById('btnChat').addEventListener('click', function() { openPanel('chatOverlay'); loadChatTranscript(); document.getElementById('chatInput').focus(); });
document.getElementById('btnSettings').addEventListener('click', function() { openPanel('settingsOverlay'); renderSettings(); });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Command Input â†’ opens chat
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.getElementById('cmdInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && this.value.trim()) {
    var cmd = this.value.trim();
    this.value = '';
    openPanel('chatOverlay');
    document.getElementById('chatInput').value = cmd;
    sendChatMessage();
  }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Agent Detail Panel
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openDetailPanel(agentId) {
  var agent = AGENTS_DATA[agentId];
  if (!agent) return;

  // Hero
  var hero = document.getElementById('detailHero');
  hero.innerHTML =
    '<div class="detail-hero-color" style="background:'+agent.color+'">'+agent.name.charAt(0)+'</div>' +
    '<div class="detail-hero-info">' +
      '<div class="detail-hero-name">'+agent.name+'</div>' +
      '<div class="detail-hero-role">'+agent.role+'</div>' +
      '<div class="detail-hero-task">'+( agent.task || 'â€”' )+'</div>' +
    '</div>' +
    '<button class="panel-close" onclick="document.getElementById(\'detailOverlay\').classList.remove(\'open\')" aria-label="Fermer">Ã—</button>';

  // Body
  var body = '';

  // Metrics
  body += '<div class="panel-section"><div class="panel-section-title">MÃ©triques</div>';
  body += '<div class="detail-metrics">';
  body += '<div class="detail-metric"><div class="detail-metric-value">'+(agent.status==='active'?'ğŸŸ¢':'ğŸ’¤')+'</div><div class="detail-metric-label">Statut</div></div>';
  body += '<div class="detail-metric"><div class="detail-metric-value">â€”</div><div class="detail-metric-label">Tokens</div></div>';
  body += '<div class="detail-metric"><div class="detail-metric-value">â€”</div><div class="detail-metric-label">API Calls</div></div>';
  body += '<div class="detail-metric"><div class="detail-metric-value">â€”</div><div class="detail-metric-label">DerniÃ¨re activitÃ©</div></div>';
  body += '</div></div>';

  // Live TODO data
  var todoData = LIVE_AGENT_DATA[agentId];
  if (todoData && todoData.currentTask) {
    body += '<div class="panel-section"><div class="panel-section-title">TÃ¢che en cours</div>';
    body += '<div style="font-size:13px;font-weight:500;color:var(--cat-text)">'+todoData.currentTask+'</div>';
    body += '</div>';
    if (todoData.todos && todoData.todos.length) {
      body += '<div class="panel-section"><div class="panel-section-title">TODO</div>';
      todoData.todos.forEach(function(todo) {
        body += '<div class="detail-todo-item'+(todo.status==='done'?' detail-todo-item--done':'')+'"><span class="detail-todo-icon">'+todo.icon+'</span><span class="detail-todo-text">'+todo.text+'</span></div>';
      });
      body += '</div>';
    }
  }

  // Skills
  if (todoData && todoData.skills && todoData.skills.length) {
    body += '<div class="panel-section"><div class="panel-section-title">CompÃ©tences</div>';
    body += '<div class="detail-skill-chips">';
    todoData.skills.forEach(function(s) {
      body += '<span class="detail-skill-chip">'+(s.name||s)+'</span>';
    });
    body += '</div></div>';
  }

  document.getElementById('detailBody').innerHTML = body;
  openPanel('detailOverlay');

  // Async: try to fill live metrics
  if (API) {
    (async function() {
      try {
        var metricsData = await API.getMetrics();
        if (metricsData && metricsData.agentBreakdown && metricsData.agentBreakdown[agentId]) {
          var ab = metricsData.agentBreakdown[agentId];
          var els = document.querySelectorAll('#detailBody .detail-metric-value');
          if (els.length >= 4) {
            if (ab.tokens) els[1].textContent = ab.tokens.toLocaleString();
            if (ab.apiCalls) els[2].textContent = ab.apiCalls.toString();
            if (ab.lastActive) els[3].textContent = ab.lastActive;
          }
        }
      } catch(e) {}
    })();
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Canvas Click â†’ Agent Detection
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// "agents" is from the canvas scope â€” access via window reference
// We piggyback on the existing canvas click by adding a listener
var _canvasEl = document.getElementById('c');
_canvasEl.addEventListener('click', function(e) {
  var r = _canvasEl.getBoundingClientRect();
  var mx = (e.clientX - r.left) / r.width * COLS * T;
  var my = (e.clientY - r.top) / r.height * ROWS * T;

  // Check proximity to each agent (within ~2 tiles)
  var found = null;
  var threshold = T * 2.5;
  for (var i = 0; i < agents.length; i++) {
    var a = agents[i];
    var ax = a.x * T;
    var ay = a.y * T - FH; // center of sprite roughly
    var dist = Math.sqrt((mx - ax) * (mx - ax) + (my - ay) * (my - ay));
    if (dist < threshold) {
      if (!found || dist < found.dist) {
        found = { agent: a, dist: dist };
      }
    }
  }

  if (found) {
    var agentId = found.agent.name.toLowerCase();
    // Exact match mapping
    if (agentId === 'apomac') agentId = 'apomac';
    openDetailPanel(agentId);
  }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Chat Panel
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loadChatTranscript() {
  if (!API) return;
  try {
    var transcript = API.getTranscript('agent:main:main');
    if (transcript && transcript.length > 0) {
      chatHistory = transcript.slice(-50).map(function(m) {
        return {
          role: m.role === 'user' ? 'user' : 'system',
          text: m.text || m.content || '',
          time: m.timestamp ? new Date(m.timestamp).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}) : ''
        };
      });
      renderChatMessages();
    }
  } catch(e) {}
}

function renderChatMessages() {
  var el = document.getElementById('chatMessages');
  var empty = document.getElementById('chatEmpty');
  if (chatHistory.length === 0) { empty.style.display = ''; return; }
  empty.style.display = 'none';
  el.innerHTML = '';
  chatHistory.forEach(function(m) {
    var div = document.createElement('div');
    div.className = 'chat-msg chat-msg--' + m.role;
    var preview = m.text.length > 300 ? m.text.substring(0, 300) + 'â€¦' : m.text;
    div.innerHTML = '<div>' + preview.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</div>' +
      (m.time ? '<div class="chat-msg-time">' + m.time + '</div>' : '');
    el.appendChild(div);
  });
  el.scrollTop = el.scrollHeight;
}

async function sendChatMessage() {
  var input = document.getElementById('chatInput');
  var text = input.value.trim();
  if (!text) return;
  input.value = '';
  var now = new Date();
  var ts = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
  chatHistory.push({ role: 'user', text: text, time: ts });
  renderChatMessages();
  if (API && typeof API.sendMission === 'function') {
    try {
      var result = await API.sendMission(text, 'ceo');
      chatHistory.push({ role: 'system', text: result && result.success ? 'âœ… Mission envoyÃ©e' : 'âš ï¸ Ã‰chec: '+(result.error||'Erreur'), time: ts });
    } catch(e) {
      chatHistory.push({ role: 'system', text: 'âš ï¸ Erreur: '+e.message, time: ts });
    }
  } else {
    chatHistory.push({ role: 'system', text: 'ğŸ“¡ API non connectÃ©e â€” message en file', time: ts });
  }
  renderChatMessages();
}

document.getElementById('chatSendBtn').addEventListener('click', sendChatMessage);
document.getElementById('chatInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') { e.preventDefault(); sendChatMessage(); }
});
setInterval(function() { if (document.getElementById('chatOverlay').classList.contains('open')) loadChatTranscript(); }, 10000);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Missions Panel
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function renderMissions() {
  var body = document.getElementById('missionsBody');
  if (!API) { body.innerHTML = '<div style="padding:30px;text-align:center;color:var(--cat-overlay0);font-size:12px;">Connectez OpenClaw pour les missions live.</div>'; return; }
  try {
    var sessions = await API.getSessions();
    var subagents = sessions.subagents || [];
    var running = subagents.filter(function(sa) { return sa.status === 'running'; });
    var completed = subagents.filter(function(sa) { return sa.status === 'completed'; }).slice(0, 5);
    if (running.length === 0 && completed.length === 0) {
      body.innerHTML = '<div style="padding:30px;text-align:center;color:var(--cat-overlay0);font-size:12px;">Aucune mission active.</div>';
      return;
    }
    var html = '';
    if (running.length > 0) {
      html += '<div class="panel-section"><div class="cron-group-title">ğŸ”´ Actives ('+running.length+')</div>';
      running.forEach(function(sa) {
        var dur = sa.durationMs ? Math.floor(sa.durationMs / 60000) + 'min' : 'â€”';
        var prog = sa.progress || 0.5;
        html += '<div class="cron-item"><span class="cron-item-icon">ğŸš€</span><div class="cron-item-info"><div class="cron-item-name">'+(sa.name||sa.label||sa.id)+'</div><div class="cron-item-schedule">Parent: '+(sa.parentAgent||'main')+' Â· '+dur+'</div><div style="margin-top:3px;height:3px;background:var(--cat-surface1);border-radius:2px;overflow:hidden;"><div style="width:'+Math.round(prog*100)+'%;height:100%;background:var(--cat-blue);border-radius:2px;"></div></div></div><span class="cron-item-status cron-item-status--active">'+Math.round(prog*100)+'%</span></div>';
      });
      html += '</div>';
    }
    if (completed.length > 0) {
      html += '<div class="panel-section"><div class="cron-group-title">âœ… TerminÃ©es ('+completed.length+')</div>';
      completed.forEach(function(sa) {
        html += '<div class="cron-item" style="opacity:0.7"><span class="cron-item-icon">âœ…</span><div class="cron-item-info"><div class="cron-item-name">'+(sa.name||sa.label||sa.id)+'</div></div><span class="cron-item-status" style="color:var(--cat-green);">OK</span></div>';
      });
      html += '</div>';
    }
    body.innerHTML = html;
  } catch(e) { body.innerHTML = '<div style="padding:30px;text-align:center;color:var(--cat-overlay0);font-size:12px;">Erreur: '+e.message+'</div>'; }
}
setInterval(function() { if (document.getElementById('missionsOverlay').classList.contains('open')) renderMissions(); }, 15000);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Crons Panel
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function humanCron(s) {
  if (!s) return 'â€”';
  var m = {'*/30 * * * *':'Toutes les 30 min','0 * * * *':'Toutes les heures','0 9 * * *':'Quotidien 9h','0 9 * * 1':'Lundi 9h','*/5 * * * *':'Toutes les 5 min','0 */2 * * *':'Toutes les 2h','0 8 * * 1-5':'Semaine 8h'};
  return m[s] || s;
}
function renderCrons() {
  var body = document.getElementById('cronsBody');
  var crons = liveCronData;
  if (API && !crons) { try { crons = API.getCrons(); } catch(e) {} }
  if (!crons || !Array.isArray(crons) || crons.length === 0) {
    body.innerHTML = '<div style="padding:30px;text-align:center;color:var(--cat-overlay0);font-size:12px;">Aucun cron trouvÃ©.'+(API?'':'<br><em>Connectez OpenClaw.</em>')+'</div>';
    return;
  }
  var groups = {};
  crons.forEach(function(c) { var o = c.owner || 'SystÃ¨me'; if (!groups[o]) groups[o] = []; groups[o].push(c); });
  var html = '';
  Object.keys(groups).forEach(function(owner) {
    html += '<div class="panel-section"><div class="cron-group-title">'+owner+'</div>';
    groups[owner].forEach(function(c) {
      var sc = c.status === 'active' ? 'active' : c.status === 'error' ? 'error' : 'paused';
      var icon = c.status === 'active' ? 'â°' : c.status === 'error' ? 'âŒ' : 'â¸ï¸';
      var next = c.nextRun ? new Date(c.nextRun).toLocaleString('fr-FR',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : 'â€”';
      html += '<div class="cron-item"><span class="cron-item-icon">'+icon+'</span><div class="cron-item-info"><div class="cron-item-name">'+(c.name||c.id||'Sans nom')+'</div><div class="cron-item-schedule">'+humanCron(c.schedule)+'</div><div class="cron-item-next">Prochain: '+next+'</div></div><span class="cron-item-status cron-item-status--'+sc+'">'+(c.status||'inconnu')+'</span></div>';
    });
    html += '</div>';
  });
  body.innerHTML = html;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Memory Panel
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderMarkdown(md) {
  if (!md) return '<em>Aucun contenu</em>';
  return md
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/^### (.+)$/gm,'<h3>$1</h3>')
    .replace(/^## (.+)$/gm,'<h2>$1</h2>')
    .replace(/^# (.+)$/gm,'<h1>$1</h1>')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/`(.+?)`/g,'<code>$1</code>')
    .replace(/^- (.+)$/gm,'<li>$1</li>')
    .replace(/\n{2,}/g,'<br><br>').replace(/\n/g,'<br>');
}
function renderMemory() {
  var body = document.getElementById('memoryBody');
  var mem = liveMemoryData;
  if (API && !mem) { try { mem = API.getMemory(); } catch(e) {} }
  if (!mem) { body.innerHTML = '<div style="padding:30px;text-align:center;color:var(--cat-overlay0);font-size:12px;">Aucune mÃ©moire disponible.'+(API?'':'<br><em>Connectez OpenClaw.</em>')+'</div>'; return; }
  var html = '';
  if (mem.longTerm && mem.longTerm.content) {
    var content = mem.longTerm.content;
    var golden = content.match(/## ğŸ”´[^\n]*\n[\s\S]*?(?=\n## |$)/g);
    if (golden && golden.length > 0) {
      html += '<div class="panel-section"><div class="panel-section-title">RÃ¨gles d\'or</div>';
      golden.forEach(function(r) { html += '<div class="memory-golden-rules"><div class="memory-content-md">'+renderMarkdown(r.trim())+'</div></div>'; });
      html += '</div>';
    }
    html += '<div class="panel-section"><div class="panel-section-title">MEMORY.md <span style="font-weight:400;color:var(--cat-overlay0);text-transform:none;letter-spacing:0">('+(mem.longTerm.size?(mem.longTerm.size/1024).toFixed(1)+' KB':'â€”')+')</span></div>';
    html += '<div class="memory-content-md">'+renderMarkdown(content.substring(0,3000))+'</div>';
    if (content.length > 3000) html += '<div style="color:var(--cat-overlay0);font-size:10px;margin-top:6px">â€¦tronquÃ© ('+content.length+' chars)</div>';
    html += '</div>';
  }
  if (mem.daily && mem.daily.length > 0) {
    html += '<div class="panel-section"><div class="panel-section-title">Notes Quotidiennes</div>';
    mem.daily.slice(0,14).forEach(function(d) {
      html += '<div class="memory-daily-item"><span class="memory-daily-item-date">'+(d.date||d.name||'â€”')+'</span><span>'+(d.preview||'Log quotidien')+'</span><span class="memory-daily-item-size">'+(d.size?(d.size/1024).toFixed(1)+' KB':'')+'</span></div>';
    });
    html += '</div>';
  }
  if (mem.heartbeat) {
    html += '<div class="panel-section"><div class="panel-section-title">Ã‰tat Heartbeat</div>';
    html += '<div class="memory-content-md"><pre style="font-size:10px;background:var(--cat-surface0);padding:8px;border-radius:6px;overflow-x:auto;color:var(--cat-subtext0)">'+JSON.stringify(mem.heartbeat,null,2).replace(/</g,'&lt;')+'</pre></div></div>';
  }
  html += '<div class="panel-section"><div class="memory-readonly">ğŸ”’ Seul le CEO peut modifier la mÃ©moire</div></div>';
  body.innerHTML = html;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Settings Panel
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function renderSettings() {
  var body = document.getElementById('settingsBody');
  var html = '';

  // API Keys
  html += '<div class="panel-section"><div class="panel-section-title">ğŸ”‘ ClÃ©s API</div>';
  var providers = ['anthropic','openai','elevenlabs','google'];
  var labels = {anthropic:'Anthropic',openai:'OpenAI',elevenlabs:'ElevenLabs',google:'Google'};
  var currentKeys = {};
  if (API) { try { currentKeys = await API.getApiKeys(); } catch(e) {} }
  providers.forEach(function(p) {
    var info = currentKeys[p] || {};
    var masked = info.hasKey ? info.masked : 'Non configurÃ©';
    html += '<div class="cron-item" style="flex-wrap:wrap;"><div class="cron-item-info" style="flex:1;min-width:120px;"><div class="cron-item-name">'+labels[p]+'</div><div class="cron-item-schedule" style="font-family:monospace;font-size:10px;">'+masked+'</div></div>';
    html += '<div style="display:flex;gap:4px;align-items:center;"><input type="password" id="apikey-'+p+'" placeholder="sk-..." style="width:140px;padding:3px 7px;border-radius:5px;border:1px solid rgba(137,180,250,0.15);font-size:10px;font-family:monospace;background:var(--cat-surface0);color:var(--cat-text);"/>';
    html += '<button class="apikey-save" data-provider="'+p+'" style="padding:3px 8px;border-radius:5px;border:none;background:var(--cat-blue);color:var(--cat-crust);font-size:10px;cursor:pointer;font-weight:500;">OK</button></div></div>';
  });
  html += '</div>';

  // Mapping
  html += '<div class="panel-section"><div class="panel-section-title">ğŸ—ºï¸ OpenClaw â†” SpawnKit</div>';
  html += '<div class="settings-mapping">';
  html += '<div class="settings-mapping-header">OpenClaw</div><div></div><div class="settings-mapping-header">SpawnKit</div>';
  [['Skills','CompÃ©tences','âš¡'],['Cron Jobs','Calendrier','ğŸ“…'],['Sessions','Agents','ğŸ‘¥'],['Memory','MÃ©moire','ğŸ§ '],['Sub-agents','Missions','ğŸ¯']].forEach(function(m) {
    html += '<div style="font-size:12px;padding:3px 0;color:var(--cat-text)">'+m[2]+' '+m[0]+'</div><div style="color:var(--cat-blue);text-align:center;font-size:11px">â†’</div><div style="font-size:12px;padding:3px 0;color:var(--cat-subtext0)">'+m[1]+'</div>';
  });
  html += '</div></div>';

  // Theme info
  html += '<div class="panel-section"><div class="panel-section-title">ğŸ¨ ThÃ¨me</div>';
  html += '<div class="cron-item"><span class="cron-item-icon">ğŸ¢</span><div class="cron-item-info"><div class="cron-item-name">Bureau Moderne (Pixel Art)</div><div class="cron-item-schedule">Catppuccin Mocha Â· 30Ã—24 tiles Â· 6 agents</div></div></div></div>';

  body.innerHTML = html;

  // Wire API key saves
  document.querySelectorAll('.apikey-save').forEach(function(btn) {
    btn.addEventListener('click', async function() {
      var p = btn.dataset.provider;
      var inp = document.getElementById('apikey-'+p);
      var key = inp ? inp.value.trim() : '';
      if (!key) { showToast('Entrez une clÃ©'); return; }
      if (API) {
        var result = await API.saveApiKey(p, key);
        if (result && result.success) { showToast('âœ… ClÃ© '+labels[p]+' sauvegardÃ©e'); inp.value = ''; renderSettings(); }
        else { showToast('âš ï¸ Ã‰chec'); }
      }
    });
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Load Live Agent Data
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadLiveAgentData() {
  var ids = Object.keys(AGENTS_DATA);
  if (!window.spawnkitAPI) {
    ids.forEach(function(id) { LIVE_AGENT_DATA[id] = { currentTask: AGENTS_DATA[id].task, todos: [], skills: [] }; });
    return;
  }
  try {
    var available = await window.spawnkitAPI.isAvailable();
    if (!available) throw new Error('not available');
    var todoP = ids.map(function(id) { return window.spawnkitAPI.getAgentTodos(id); });
    var skillP = ids.map(function(id) { return window.spawnkitAPI.getAgentSkills(id); });
    var allTodos = await Promise.all(todoP);
    var allSkills = await Promise.all(skillP);
    ids.forEach(function(id, i) {
      var td = allTodos[i] || { todos: [], currentTask: 'Standby' };
      var sk = allSkills[i] || [];
      LIVE_AGENT_DATA[id] = {
        currentTask: td.currentTask || AGENTS_DATA[id].task,
        todos: td.todos || [],
        skills: sk.map(function(s,idx) { return {name:s.name||s.dirName||'Skill',percentage:Math.max(70,95-idx*5)}; })
      };
    });
    console.log('ğŸ¢ [Modern] Loaded live agent data for', ids.length, 'agents');
  } catch(e) {
    ids.forEach(function(id) { LIVE_AGENT_DATA[id] = { currentTask: AGENTS_DATA[id].task, todos: [], skills: [] }; });
  }
}

/* Pre-fetch panel data */
function prefetchPanelData() {
  if (!API) return;
  try { liveCronData = API.getCrons(); } catch(e) {}
  try { liveMemoryData = API.getMemory(); } catch(e) {}
}
prefetchPanelData();
setInterval(prefetchPanelData, 30000);
loadLiveAgentData();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Enhanced Data Bridge â€” postMessage + auto-refresh
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.addEventListener('message', function(e) {
  if (!e.data || typeof e.data !== 'object') return;
  switch (e.data.type) {
    case 'fleetkit:getState':
      // Handled by canvas-level postState already
      break;
    case 'fleetkit:update':
      if (e.data.agents) {
        for (var u of e.data.agents) {
          var a = agents.find(function(x) { return x.name === u.name; });
          if (a) { if (u.task) a.task = u.task; if (u.status) a.status = u.status; }
          // Also update AGENTS_DATA
          var aid = u.name ? u.name.toLowerCase() : '';
          if (AGENTS_DATA[aid]) {
            if (u.task) AGENTS_DATA[aid].task = u.task;
            if (u.status) AGENTS_DATA[aid].status = u.status;
          }
        }
      }
      break;
    case 'spawnkit:data': handleSpawnKitData(e.data.payload); break;
    case 'spawnkit:agents': handleAgentsUpdate(e.data.agents); break;
    case 'spawnkit:ping':
      if (window.parent !== window) {
        window.parent.postMessage({ type: 'modern:pong', theme: 'office-modern', timestamp: Date.now() }, '*');
      }
      break;
  }
});

function handleSpawnKitData(payload) {
  if (!payload) return;
  if (payload.agents) handleAgentsUpdate(payload.agents);
  if (payload.agents) {
    var count = payload.agents.length;
    document.getElementById('sbAgentCount').textContent = count + ' Agent' + (count !== 1 ? 's' : '');
  }
}

function handleAgentsUpdate(agentsList) {
  if (!agentsList || !Array.isArray(agentsList)) return;
  agentsList.forEach(function(ag) {
    if (!ag || !ag.name) return;
    var id = ag.name.toLowerCase();
    if (AGENTS_DATA[id]) {
      if (ag.status) AGENTS_DATA[id].status = ag.status;
      if (ag.task || ag.currentTask) AGENTS_DATA[id].task = ag.task || ag.currentTask;
    }
  });
}

// Announce readiness
if (window.parent !== window) {
  window.parent.postMessage({ type: 'modern:ready', theme: 'office-modern', timestamp: Date.now() }, '*');
}

// Auto-refresh state every 5s (same as original but we keep both)
// Original postState interval is already set in canvas code

// Wire SpawnKit if available
if (window.SpawnKit) {
  SpawnKit.on('data:refresh', function(data) {
    if (typeof handleSpawnKitData === 'function') handleSpawnKitData(data);
  });
  if (SpawnKit.mode === 'live') {
    SpawnKit.refresh();
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Live Activity Simulation â€” keep office alive
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var ACTIVITY = {
  apomac: {verbs:['Orchestration','Revue','Planification'],objects:['fleet','roadmap','stratÃ©gie']},
  forge:  {verbs:['Build','DÃ©ploiement','Refactoring'],objects:['API','dashboard','infra']},
  hunter: {verbs:['Prospection','Analyse','Closing'],objects:['leads','pipeline','deals']},
  atlas:  {verbs:['Coordination','Sync','Documentation'],objects:['workflows','ops','crons']},
  echo:   {verbs:['RÃ©daction','Design','Publication'],objects:['contenu','campagne','brand']},
  sentinel:{verbs:['Scan','Audit','Surveillance'],objects:['code','sÃ©curitÃ©','qualitÃ©']}
};

function randomTask(id) {
  var a = ACTIVITY[id]; if (!a) return '';
  return a.verbs[Math.floor(Math.random()*a.verbs.length)] + ' ' + a.objects[Math.floor(Math.random()*a.objects.length)];
}

function simulateActivityModern() {
  var ids = Object.keys(AGENTS_DATA);
  var tid = ids[Math.floor(Math.random()*ids.length)];
  AGENTS_DATA[tid].task = randomTask(tid);
  setTimeout(simulateActivityModern, 15000 + Math.random() * 30000);
}
setTimeout(simulateActivityModern, 8000);

/* Uptime in status bar */
var startTime = Date.now() - (8 * 3600000 + 23 * 60000);
function updateUptime() {
  var elapsed = Date.now() - startTime;
  var h = Math.floor(elapsed / 3600000);
  var m = Math.floor((elapsed % 3600000) / 60000);
  var el = document.getElementById('sbAgentCount');
  if (el) el.textContent = '6 Agents Â· ' + h + 'h' + m.toString().padStart(2,'0') + 'm';
}
updateUptime();
setInterval(updateUptime, 60000);

console.log('âœ… Office-Modern v4.0 â€” Panels + Data Bridge + Status Bar ported');
console.log('   - Agent Detail, Chat, Missions, Crons, Memory, Settings panels');
console.log('   - Canvas click â†’ agent detection â†’ detail panel');
console.log('   - Catppuccin Mocha themed overlay UI');
console.log('   - data-bridge.js + postMessage + auto-refresh');

})();
</script>
</body>
</html>