<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpawnKit â€” Medieval Castle 3D</title>
    <script>
        if (window.location.hostname.includes('spawnkit.ai')) {
            window.OC_RELAY_URL = window.location.origin;
        } else {
            window.OC_RELAY_URL = window.OC_RELAY_URL || 'http://127.0.0.1:18790';
        }
        var API_URL = window.OC_API_URL || (window.location.hostname.includes('spawnkit.ai') ? window.location.origin : 'http://127.0.0.1:8765');
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Cinzel:wght@400;500;600;700&family=Crimson+Text:wght@400;600&display=swap" rel="stylesheet">
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.162.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.162.0/examples/jsm/"
        }
    }
    </script>
    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SpawnKit Medieval Castle v4.0 â€” Three.js 3D Diorama
           Real Kenney .glb models, isometric camera, animated characters
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        :root {
            --castle-dark-navy: #1a1a2e;
            --castle-navy: #16213e;
            --castle-blue: #0f3460;
            --castle-red: #e94560;
            --castle-gold: #c9a959;
            --castle-brown: #8b7355;
            --castle-parchment: #f4e4bc;
            --castle-stone-light: #a8a299;
            --castle-stone-dark: #5c5750;
            --castle-black: #0d0d0d;
            --castle-silver: #c0c0c0;
            --bg-primary: var(--castle-dark-navy);
            --bg-secondary: var(--castle-navy);
            --bg-tertiary: var(--castle-blue);
            --bg-parchment: var(--castle-parchment);
            --bg-scroll: linear-gradient(145deg, #f4e4bc 0%, #e8d5a3 100%);
            --text-primary: var(--castle-parchment);
            --text-secondary: var(--castle-stone-light);
            --text-accent: var(--castle-gold);
            --text-dark: var(--castle-navy);
            --text-red: var(--castle-red);
            --border-stone: rgba(168, 162, 153, 0.3);
            --border-gold: rgba(201, 169, 89, 0.5);
            --status-active: #4ade80;
            --status-busy: #fbbf24;
            --status-idle: #64748b;
            --status-error: var(--castle-red);
            --font-medieval: 'MedievalSharp', fantasy;
            --font-serif: 'Cinzel', serif;
            --font-body: 'Crimson Text', serif;
            --font-mono: 'Courier New', monospace;
            --space-1: 4px; --space-2: 8px; --space-3: 12px; --space-4: 16px;
            --space-5: 20px; --space-6: 24px; --space-8: 32px;
            --radius-sm: 4px; --radius-md: 8px; --radius-lg: 12px;
            --shadow-deep: 0 8px 32px rgba(0,0,0,0.6);
        }

        /* â•â•â• MISSION CONTROL CSS â•â•â• */
        .mc-overlay {
            position: fixed; inset: 0; z-index: 1000;
            background: linear-gradient(145deg, var(--castle-dark-navy) 0%, var(--castle-navy) 50%, var(--castle-blue) 100%);
            backdrop-filter: blur(20px);
            display: none; flex-direction: column;
            opacity: 0; transform: translateY(20px);
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .mc-overlay.visible { opacity: 1; transform: translateY(0); }
        
        .mc-header {
            display: flex; align-items: center; gap: 16px; padding: 16px 24px;
            background: rgba(13, 13, 26, 0.8); border-bottom: 2px solid var(--border-gold);
        }
        .mc-back {
            display: flex; align-items: center; gap: 8px; padding: 6px 12px;
            background: var(--castle-gold); color: var(--castle-navy);
            border: none; border-radius: 8px; font-family: var(--font-serif);
            font-weight: 600; cursor: pointer; transition: all 0.15s;
        }
        .mc-back:hover { background: #d4b76a; }
        .mc-title {
            font-family: var(--font-medieval); font-size: 20px;
            color: var(--castle-gold); display: flex; align-items: center; gap: 8px;
        }
        .mc-title-badge {
            font-family: var(--font-serif); font-size: 11px;
            background: rgba(201, 169, 89, 0.2); color: var(--castle-gold);
            padding: 2px 8px; border-radius: 6px; text-transform: uppercase;
        }
        
        .mc-body {
            flex: 1; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;
            padding: 16px 24px; overflow: hidden;
        }
        .mc-col {
            background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border-stone);
            border-radius: 12px; padding: 16px; overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        .mc-col::-webkit-scrollbar { width: 4px; }
        .mc-col::-webkit-scrollbar-thumb { background: var(--border-gold); border-radius: 2px; }
        
        .mc-section-title {
            font-size: 10px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.8px; color: var(--castle-stone-light);
            margin-bottom: 8px; display: flex; align-items: center; gap: 6px;
        }
        
        /* Mission cards with medieval style */
        .mc-mission {
            padding: 12px; border-radius: 12px; margin-bottom: 8px;
            background: var(--bg-scroll); backdrop-filter: blur(8px);
            border: 1px solid var(--border-gold); cursor: pointer; transition: all 0.15s;
        }
        .mc-mission:hover { border-color: var(--castle-gold); box-shadow: 0 2px 8px rgba(201, 169, 89, 0.3); }
        .mc-mission-name { font-size: 14px; font-weight: 600; color: var(--text-dark); margin-bottom: 4px; }
        .mc-mission-meta { font-size: 11px; color: var(--castle-brown); display: flex; gap: 8px; align-items: center; margin-bottom: 6px; }
        .mc-progress { height: 4px; border-radius: 2px; background: var(--border-stone); overflow: hidden; }
        .mc-progress-fill { height: 100%; border-radius: 2px; background: var(--castle-gold); transition: width 0.3s; }
        .mc-mission-tasks { margin-top: 8px; display: none; }
        .mc-mission.expanded .mc-mission-tasks { display: block; }
        .mc-task-row {
            display: flex; align-items: center; gap: 8px; padding: 5px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1); font-size: 12px;
        }
        .mc-task-row:last-child { border-bottom: none; }
        .mc-task-name { flex: 1; color: var(--text-dark); }
        .mc-task-assignee { font-size: 10px; color: var(--castle-navy); padding: 1px 6px; border-radius: 4px; background: rgba(201, 169, 89, 0.3); }
        .mc-task-status { font-size: 10px; font-weight: 600; padding: 1px 6px; border-radius: 4px; }
        .mc-task-status--done { background: rgba(74, 222, 128, 0.2); color: var(--status-active); }
        .mc-task-status--active { background: rgba(15, 52, 96, 0.3); color: var(--castle-blue); }
        .mc-task-status--review { background: rgba(233, 69, 96, 0.2); color: var(--castle-red); }
        .mc-task-status--pending { background: var(--border-stone); color: var(--castle-stone-dark); }
        
        /* TODO.md with parchment look */
        .mc-todo-raw {
            padding: 10px 12px; border-radius: 10px; margin-top: 8px;
            background: var(--bg-scroll); border: 1px solid var(--border-gold);
            font-size: 12px; color: var(--text-dark); line-height: 1.6;
            max-height: 200px; overflow-y: auto; font-family: var(--font-body);
        }
        .mc-todo-toggle {
            font-size: 11px; font-weight: 600; color: var(--castle-gold);
            cursor: pointer; margin-top: 8px; display: inline-block;
        }
        
        /* Activity feed with medieval icons */
        .mc-feed-item {
            display: flex; gap: 10px; padding: 10px 0;
            border-bottom: 1px solid var(--border-stone);
        }
        .mc-feed-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
        .mc-feed-body { flex: 1; min-width: 0; }
        .mc-feed-text { font-size: 13px; color: var(--text-primary); line-height: 1.4; }
        .mc-feed-time { font-size: 10px; color: var(--castle-stone-light); margin-top: 2px; }
        .mc-feed-detail { font-size: 11px; color: var(--text-secondary); margin-top: 4px; display: none; padding: 6px 8px; border-radius: 6px; background: rgba(0,0,0,0.2); }
        .mc-feed-item.expanded .mc-feed-detail { display: block; }
        
        .mc-feed-toggle {
            display: flex; gap: 0; margin-bottom: 12px; border-radius: 8px; overflow: hidden;
            border: 1px solid var(--border-gold);
        }
        .mc-feed-toggle-btn {
            flex: 1; padding: 6px 12px; border: none; background: transparent;
            font-size: 11px; font-weight: 600; cursor: pointer; font-family: var(--font-serif);
            color: var(--castle-stone-light); transition: all 0.15s;
        }
        .mc-feed-toggle-btn.active { background: var(--castle-gold); color: var(--castle-navy); }
        
        .mc-raw-transcript {
            font-family: var(--font-mono); font-size: 11px;
            line-height: 1.5; color: var(--text-secondary);
            white-space: pre-wrap; word-break: break-word;
            padding: 12px; border-radius: 10px; background: rgba(0,0,0,0.2);
            max-height: 100%; overflow-y: auto; display: none;
        }
        
        /* Fleet pastilles with medieval styling */
        .mc-fleet-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-bottom: 12px;
        }
        .mc-fleet-pill {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            padding: 8px 4px; border-radius: 10px; background: var(--bg-scroll);
            border: 1px solid var(--border-gold); cursor: pointer; transition: all 0.15s;
        }
        .mc-fleet-pill:hover { border-color: var(--castle-gold); box-shadow: 0 0 12px rgba(201, 169, 89, 0.4); }
        .mc-fleet-pill-dot { width: 8px; height: 8px; border-radius: 50%; }
        .mc-fleet-pill-name { font-size: 10px; font-weight: 600; color: var(--text-dark); }
        
        /* Sub-agent list */
        .mc-sub-item {
            display: flex; align-items: center; gap: 8px; padding: 6px 0;
            border-bottom: 1px solid var(--border-stone);
        }
        .mc-sub-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
        .mc-sub-name { font-size: 12px; font-weight: 500; color: var(--text-primary); flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .mc-sub-meta { font-size: 10px; color: var(--castle-stone-light); white-space: nowrap; }
        
        /* Bottom status bar */
        .mc-statusbar {
            display: flex; align-items: center; gap: 16px; padding: 8px 24px;
            background: rgba(13, 13, 26, 0.9); backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-gold); font-size: 11px; color: var(--castle-stone-light);
            flex-shrink: 0;
        }
        .mc-statusbar-item { display: flex; align-items: center; gap: 4px; }
        .mc-statusbar-dot { width: 6px; height: 6px; border-radius: 50%; }

        /* Status pulse animation */
        @keyframes statusPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .mc-body { grid-template-columns: 1fr; }
            .mc-col:nth-child(3) { display: none; }
        }

        /* â•â•â• AGENT DETAIL PANEL CSS â•â•â• */
        .agent-detail-overlay {
            position: fixed; inset: 0; z-index: 900;
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center;
            opacity: 0; transition: all 0.3s ease;
        }
        .agent-detail-overlay.visible { opacity: 1; }
        .agent-detail-panel {
            background: var(--bg-scroll); border: 2px solid var(--castle-gold);
            border-radius: 16px; padding: 24px; max-width: 500px; width: 90%;
            transform: scale(0.9); transition: transform 0.3s ease;
            box-shadow: var(--shadow-deep);
        }
        .agent-detail-overlay.visible .agent-detail-panel { transform: scale(1); }
        .agent-detail-header {
            display: flex; align-items: center; gap: 12px; margin-bottom: 20px;
            padding-bottom: 12px; border-bottom: 1px solid var(--border-gold);
        }
        .agent-detail-avatar {
            width: 48px; height: 48px; border-radius: 12px;
            background: var(--castle-gold); display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: var(--castle-navy);
        }
        .agent-detail-info h3 {
            font-family: var(--font-medieval); font-size: 18px;
            color: var(--castle-navy); margin-bottom: 4px;
        }
        .agent-detail-info p {
            font-size: 14px; color: var(--castle-brown); margin: 0;
        }
        .agent-detail-close {
            margin-left: auto; background: var(--castle-red); color: white;
            border: none; border-radius: 8px; width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 16px;
        }
        .agent-detail-tabs {
            display: flex; gap: 4px; margin-bottom: 16px;
            background: rgba(201, 169, 89, 0.1); border-radius: 8px; padding: 4px;
        }
        .agent-detail-tab {
            flex: 1; padding: 8px 12px; border: none; background: transparent;
            font-family: var(--font-serif); font-size: 12px; font-weight: 600;
            color: var(--castle-brown); border-radius: 6px; cursor: pointer;
            transition: all 0.15s;
        }
        .agent-detail-tab.active {
            background: var(--castle-gold); color: var(--castle-navy);
        }
        .agent-detail-content {
            min-height: 200px; color: var(--castle-navy);
        }
        .thoughts-feed { max-height: 240px; overflow-y: auto; }
        .thought-entry { display: flex; gap: 10px; padding: 8px 0; border-bottom: 1px solid rgba(201,169,89,0.15); }
        .thought-entry:last-child { border-bottom: none; }
        .thought-time { font-size: 11px; color: var(--castle-brown); opacity: 0.6; min-width: 36px; padding-top: 2px; font-family: var(--font-serif); }
        .thought-text { font-size: 13px; color: var(--castle-navy); line-height: 1.4; flex: 1; }
        .thought-emoji { font-size: 16px; min-width: 24px; text-align: center; }
        .mood-bar { height: 6px; border-radius: 3px; background: rgba(0,0,0,0.1); overflow: hidden; margin-top: 4px; }
        .mood-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
        .summon-model-btn.active { background: var(--castle-gold) !important; border-color: var(--castle-navy) !important; font-weight: 600; }
        .theme-card { background:rgba(255,255,255,0.1);border:2px solid rgba(201,169,89,0.2);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.2s;text-align:center; }
        .theme-card:hover { border-color:var(--castle-gold);background:rgba(201,169,89,0.1); }
        .theme-card-icon { font-size:32px;margin-bottom:8px; }
        .theme-card-name { font-family:var(--font-medieval);font-size:14px;color:var(--castle-gold);margin-bottom:4px; }
        .theme-card-desc { font-size:12px;color:var(--castle-brown);opacity:0.7; }
        .theme-card-badge { display:inline-block;margin-top:6px;font-size:10px;padding:2px 8px;border-radius:10px;font-weight:600; }
        #medievalChat { display: flex; flex-direction: column; }
        #medievalChat .sk-chat { flex: 1; min-height: 0; display: flex; flex-direction: column; }
        #medievalChat .sk-chat-messages { flex: 1; min-height: 0; overflow-y: auto; }
        #medievalChat .sk-chat-input-bar { flex-shrink: 0; }
        @media (max-width: 480px) {
            #medievalChat { right: 0 !important; left: 0 !important; width: 100% !important; max-width: 100vw !important; bottom: 64px !important; border-radius: 12px 12px 0 0 !important; }
        }
        #knightsDropdown { scrollbar-width: thin; }
        .kr-row { display: flex; align-items: center; gap: 10px; padding: 10px 14px; cursor: pointer; transition: background 0.12s; border-bottom: 1px solid rgba(201,169,89,0.12); }
        .kr-row:last-child { border-bottom: none; }
        .kr-row:hover { background: rgba(201,169,89,0.15); }
        .kr-row.kr-selected { background: rgba(201,169,89,0.25); }
        .kr-avatar { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; overflow: hidden; flex-shrink: 0; }
        .kr-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .kr-info { flex: 1; min-width: 0; }
        .kr-name { font-family: var(--font-serif); font-size: 13px; font-weight: 600; color: var(--castle-navy); }
        .kr-role { font-size: 11px; color: var(--castle-brown); opacity: 0.7; }
        .kr-right { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
        .kr-emoji { font-size: 16px; }
        .kr-status { width: 8px; height: 8px; border-radius: 50%; }
        .kr-status.active { background: var(--status-active); box-shadow: 0 0 4px var(--status-active); }
        .kr-status.idle { background: #888; }
        .kr-section { padding: 6px 14px; font-family: var(--font-serif); font-size: 11px; font-weight: 600; color: var(--castle-brown); opacity: 0.6; text-transform: uppercase; letter-spacing: 1px; background: rgba(0,0,0,0.03); }
        .agent-metrics-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
        }
        .agent-metric-card {
            background: rgba(255, 255, 255, 0.5); border: 1px solid var(--border-gold);
            border-radius: 8px; padding: 12px; text-align: center;
        }
        .agent-metric-value {
            font-family: var(--font-serif); font-size: 20px; font-weight: 600;
            color: var(--castle-red); display: block; margin-bottom: 4px;
        }
        .agent-metric-label {
            font-size: 11px; color: var(--castle-brown);
            text-transform: uppercase; letter-spacing: 0.5px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--castle-dark-navy);
            color: var(--text-primary);
            font-family: var(--font-body);
            overflow: hidden;
            height: 100vh;
        }

        /* â”€â”€ Main Grid Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .castle-layout {
            display: grid;
            grid-template-areas: "header header" "main main";
            grid-template-columns: 1fr;
            grid-template-rows: auto 1fr;
            height: 100vh;
            overflow: hidden;
        }

        /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .castle-header {
            grid-area: header;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 16px;
            height: 36px;
            background: linear-gradient(135deg, #0d0d1a 0%, var(--castle-navy) 50%, #0d0d1a 100%);
            border-bottom: 1px solid var(--border-stone);
            z-index: 10;
        }
        .castle-banner { display: flex; align-items: center; gap: 8px; }
        .castle-crest { font-size: 18px; filter: drop-shadow(0 0 8px rgba(201,169,89,0.6)); }
        .castle-name { font-family: var(--font-medieval); font-size: 14px; color: var(--castle-gold); letter-spacing: 2px; margin: 0; }
        .castle-subtitle { display: none; }
        .castle-status-bar { display: flex; gap: var(--space-6); align-items: center; }
        .status-indicator { display: flex; align-items: center; gap: var(--space-2); font-size: 13px; font-family: var(--font-serif); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-dot.active { background: var(--status-active); box-shadow: 0 0 6px var(--status-active); }
        .status-dot.busy { background: var(--status-busy); box-shadow: 0 0 6px var(--status-busy); }

        /* â”€â”€ Left Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .castle-sidebar {
            position: fixed;
            left: -320px;
            top: 0;
            width: 310px;
            height: 100vh;
            z-index: 50;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--bg-secondary);
            border-right: 2px solid var(--border-stone);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .castle-sidebar.panel-open {
            left: 0;
        }
        .sidebar-header {
            padding: var(--space-5) var(--space-4);
            border-bottom: 1px solid var(--border-stone);
            background: linear-gradient(135deg, var(--castle-stone-dark), var(--castle-navy));
        }
        .sidebar-title { font-family: var(--font-medieval); font-size: 18px; color: var(--castle-gold); text-align: center; }
        .agents-scroll { flex: 1; overflow-y: auto; padding: var(--space-3); }

        .agent-card {
            background: linear-gradient(135deg, rgba(22,33,62,0.9), rgba(15,52,96,0.4));
            border: 1px solid var(--border-stone);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            margin-bottom: var(--space-2);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .agent-card:hover { border-color: var(--castle-gold); transform: translateX(3px); box-shadow: 0 2px 8px rgba(201,169,89,0.15); }
        .agent-card.selected { border-color: var(--castle-red); box-shadow: 0 0 12px rgba(233,69,96,0.3); background: linear-gradient(135deg, rgba(233,69,96,0.1), rgba(15,52,96,0.4)); }
        .agent-header { display: flex; align-items: center; gap: var(--space-3); }
        .agent-avatar {
            width: 40px; height: 40px; border-radius: var(--radius-md);
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; background: var(--castle-stone-dark);
        }
        .agent-avatar img { width: 100%; height: 100%; object-fit: cover; image-rendering: pixelated; }
        .agent-name { font-family: var(--font-serif); font-size: 14px; color: var(--text-primary); font-weight: 600; }
        .agent-role { font-size: 11px; color: var(--text-secondary); font-style: italic; }
        .agent-status { margin-left: auto; display: flex; align-items: center; gap: 4px; }
        .agent-metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-2); margin-top: var(--space-2); padding-top: var(--space-2); border-top: 1px solid rgba(168,162,153,0.15); }
        .metric-item { text-align: center; }
        .metric-label { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; display: block; }
        .metric-value { font-family: var(--font-serif); font-size: 13px; color: var(--castle-gold); font-weight: 600; }

        /* â”€â”€ Main Scene (Three.js Canvas) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .castle-main {
            grid-area: main;
            position: relative;
            overflow: hidden;
            background: #0a0a1a;
        }
        .castle-main canvas {
            display: block;
            width: 100% !important;
            height: 100% !important;
        }

        /* â”€â”€ Scene Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .scene-controls {
            position: absolute;
            top: var(--space-3); left: var(--space-3);
            z-index: 30;
            display: flex; gap: var(--space-2);
        }
        .control-btn {
            width: 32px; height: 32px;
            border: 1px solid var(--border-gold);
            border-radius: var(--radius-sm);
            background: rgba(201,169,89,0.9);
            color: var(--castle-navy);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 14px;
            transition: all 0.2s;
        }
        .control-btn:hover { background: var(--castle-parchment); transform: translateY(-1px); }

        /* â”€â”€ Character Name Labels (HTML overlay) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .character-label {
            position: absolute;
            pointer-events: none;
            font-family: var(--font-serif);
            font-size: 11px;
            color: var(--castle-gold);
            text-shadow: 0 0 6px rgba(0,0,0,0.95), 0 1px 3px black, 0 0 12px rgba(0,0,0,0.8);
            white-space: nowrap;
            transform: translate(-50%, -100%);
            padding: 2px 8px;
            background: rgba(0,0,0,0.55);
            border: 1px solid rgba(201,169,89,0.4);
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 20;
            font-weight: 600;
        }
        .character-label.visible { opacity: 1; }
        .character-label.selected {
            opacity: 1;
            color: var(--castle-red);
            border-color: rgba(233,69,96,0.6);
            background: rgba(0,0,0,0.7);
        }

        /* â”€â”€ Building Name Labels (HTML overlay) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .speech-bubble {
            position: absolute;
            font-size: 11px;
            color: #fff;
            background: rgba(20, 15, 10, 0.85);
            padding: 4px 10px;
            border-radius: 10px;
            pointer-events: none;
            white-space: nowrap;
            transform: translate(-50%, -100%);
            z-index: 15;
            animation: speechFade 3s ease-out forwards;
            border: 1px solid rgba(255, 200, 100, 0.3);
        }
        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            margin-left: -4px;
            border-width: 6px 4px 0;
            border-style: solid;
            border-color: rgba(20, 15, 10, 0.85) transparent transparent;
        }
        @keyframes speechFade {
            0% { opacity: 0; transform: translate(-50%, -100%) scale(0.8); }
            10% { opacity: 1; transform: translate(-50%, -100%) scale(1); }
            70% { opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -120%); }
        }
        .building-label {
            position: absolute;
            font-size: 11px;
            font-weight: 600;
            color: #fff;
            background: rgba(0,0,0,0.6);
            padding: 2px 8px;
            border-radius: 8px;
            pointer-events: none;
            white-space: nowrap;
            transform: translate(-50%, -100%);
            z-index: 10;
            transition: opacity 0.3s;
            max-width: calc(100vw - 380px); /* don't extend under right panel */
        }

        /* â”€â”€ Loading Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .loading-screen {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, #0d0d1a, var(--castle-navy));
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 100;
            transition: opacity 0.8s ease;
        }
        .loading-screen.hidden { opacity: 0; pointer-events: none; }
        .loading-title {
            font-family: var(--font-medieval);
            font-size: 28px;
            color: var(--castle-gold);
            margin-bottom: 24px;
            text-shadow: 0 0 20px rgba(201,169,89,0.4);
        }
        .loading-bar-container {
            width: 300px;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid var(--border-gold);
        }
        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--castle-gold), var(--castle-red));
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }
        .loading-text {
            font-family: var(--font-serif);
            font-size: 12px;
            color: var(--castle-stone-light);
            margin-top: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* â”€â”€ Right Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .castle-rightpanel {
            position: fixed;
            right: -380px;
            top: 0;
            width: 370px;
            height: 100vh;
            z-index: 50;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--bg-secondary);
            border-left: 2px solid var(--border-stone);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .castle-rightpanel.panel-open {
            right: 0;
        }
        .rightpanel-header {
            padding: var(--space-5) var(--space-4);
            border-bottom: 1px solid var(--border-stone);
            background: linear-gradient(135deg, var(--castle-stone-dark), var(--castle-navy));
        }
        .rightpanel-title { font-family: var(--font-medieval); font-size: 18px; color: var(--castle-gold); text-align: center; }
        .activity-scroll { flex: 1; overflow-y: auto; padding: var(--space-3); }

        .activity-item {
            background: var(--bg-scroll);
            border: 1px solid var(--border-gold);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            margin-bottom: var(--space-3);
            color: var(--text-dark);
            transition: transform 0.2s ease;
        }
        .activity-item:first-child { border-color: var(--castle-gold); box-shadow: 0 1px 6px rgba(201,169,89,0.15); }
        .activity-time { font-size: 11px; color: var(--castle-brown); margin-bottom: 2px; }
        .activity-message { font-size: 13px; line-height: 1.5; color: var(--castle-navy); }
        .activity-agent { font-weight: 600; color: var(--castle-red); }

        /* â”€â”€ Stats Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .stats-panel {
            background: var(--bg-scroll);
            border: 2px solid var(--castle-gold);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin: var(--space-3);
        }
        .stats-title { font-family: var(--font-medieval); font-size: 16px; color: var(--castle-navy); text-align: center; margin-bottom: var(--space-3); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3); }
        .stat-item { text-align: center; }
        .stat-value { font-family: var(--font-serif); font-size: 20px; font-weight: 600; color: var(--castle-red); display: block; }
        .stat-label { font-size: 12px; color: var(--castle-brown); text-transform: uppercase; letter-spacing: 0.5px; }

        /* â”€â”€ Demo Badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .demo-badge {
            position: fixed; top: 6px; right: 6px;
            background: var(--castle-red); color: white;
            padding: 2px 8px; border-radius: var(--radius-sm);
            font-family: var(--font-serif); font-size: 11px; font-weight: 600;
            text-transform: uppercase; z-index: 1000;
        }

        /* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .agents-scroll::-webkit-scrollbar, .activity-scroll::-webkit-scrollbar { width: 8px; }
        .agents-scroll::-webkit-scrollbar-track, .activity-scroll::-webkit-scrollbar-track { background: var(--castle-stone-dark); }
        .agents-scroll::-webkit-scrollbar-thumb, .activity-scroll::-webkit-scrollbar-thumb { background: var(--castle-gold); border-radius: 4px; }

        /* â”€â”€ Building Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .building-panel {
            position: fixed;
            right: -420px;
            top: 36px;
            width: 400px;
            height: calc(100vh - 36px);
            background: var(--bg-secondary);
            border-left: 2px solid var(--border-stone);
            z-index: 60;
            transition: right 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            box-shadow: -4px 0 20px rgba(0,0,0,0.4);
        }
        .building-panel.panel-open {
            right: 0;
        }
        .building-panel-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-stone);
            background: linear-gradient(135deg, var(--castle-stone-dark), var(--castle-navy));
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .building-panel-header span:first-child { font-size: 20px; }
        .building-panel-header span:nth-child(2) { font-family: var(--font-medieval); font-size: 16px; color: var(--castle-gold); flex: 1; }
        .building-panel-content {
            padding: 16px;
        }

        /* â”€â”€ Panel Close Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .panel-close-btn {
            background: none;
            border: none;
            color: var(--castle-gold);
            font-size: 20px;
            cursor: pointer;
            z-index: 51;
            line-height: 1;
        }
        .panel-close-btn:hover { color: var(--castle-parchment); }

        /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 1200px) { }
        @media (max-width: 1024px) { }
    </style>
</head>
<body>
    <script>
        if (window.location.hostname.includes('spawnkit.ai')) {
            window.OC_RELAY_URL = window.location.origin;
        } else {
            window.OC_RELAY_URL = 'http://localhost:18790';
        }
        window.OC_RELAY_TOKEN = localStorage.getItem('spawnkit-token') || 'sk-oc-proxy-spawnkit-2026';
    </script>

    <div class="castle-layout">
        <header class="castle-header">
            <div class="castle-banner">
                <div class="castle-crest">ğŸ°</div>
                <div>
                    <h1 class="castle-name">Royal Command</h1>
                    <div class="castle-subtitle">Medieval AI Fleet</div>
                </div>
            </div>
            <div class="castle-status-bar">
                <div class="status-indicator"><div class="status-dot active"></div><span>Castle Online</span></div>
                <div class="status-indicator" id="knightsToggle" style="cursor:pointer;position:relative;"><div class="status-dot busy"></div><span id="active-agents">Loading...</span><span style="font-size:10px;opacity:0.5;margin-left:4px;">â–¼</span></div>
            </div>
            <!-- Knights Roster Dropdown -->
            <div id="knightsDropdown" style="display:none;position:absolute;top:36px;right:8px;width:320px;max-height:420px;overflow-y:auto;z-index:60;background:var(--bg-scroll);border:2px solid var(--border-gold);border-radius:12px;box-shadow:var(--shadow-deep);"></div>
        </header>

        <aside class="castle-sidebar">
            <div class="sidebar-header" style="position:relative;"><h2 class="sidebar-title">âš”ï¸ Royal Court</h2><button class="panel-close-btn" onclick="document.querySelector('.castle-sidebar').classList.remove('panel-open')" style="position:absolute;top:8px;right:8px;">âœ•</button></div>
            <div class="agents-scroll" id="agents-list"></div>
        </aside>

        <main class="castle-main" id="scene-container">
            <!-- Loading Screen -->
            <div class="loading-screen" id="loading-screen">
                <div class="loading-title">âš”ï¸ Summoning the Castle</div>
                <div class="loading-bar-container">
                    <div class="loading-bar" id="loading-bar"></div>
                </div>
                <div class="loading-text" id="loading-text">Preparing siege...</div>
            </div>

            <!-- Character label overlays -->
            <div id="labels-container"></div>

            <!-- Controls (hidden â€” hotbar handles all navigation) -->
            <div class="scene-controls" style="display:none;">
                <button class="control-btn" id="btn-toggle-sound" title="Toggle Sound">ğŸ”Š</button>
                <button class="control-btn" id="btn-fullscreen" title="Fullscreen">â›¶</button>
                <button class="control-btn" id="btn-reset-camera" title="Reset Camera">ğŸ¯</button>
            </div>
        </main>

        <aside class="castle-rightpanel">
            <div class="rightpanel-header" style="position:relative;"><h2 class="rightpanel-title">ğŸ“œ Royal Decrees</h2><button class="panel-close-btn" onclick="document.querySelector('.castle-rightpanel').classList.remove('panel-open')" style="position:absolute;top:8px;left:8px;">âœ•</button></div>
            <div class="stats-panel">
                <h3 class="stats-title">Castle Status</h3>
                <div class="stats-grid">
                    <div class="stat-item"><span class="stat-value" id="stat-missions">12</span><span class="stat-label">Quests</span></div>
                    <div class="stat-item"><span class="stat-value" id="stat-completed">8</span><span class="stat-label">Done</span></div>
                    <div class="stat-item"><span class="stat-value" id="stat-resources">2.4k</span><span class="stat-label">Gold</span></div>
                    <div class="stat-item"><span class="stat-value" id="stat-uptime">99.8%</span><span class="stat-label">Uptime</span></div>
                </div>
            </div>
            <div class="activity-scroll" id="activity-log"></div>
        </aside>
    </div>

    <div class="demo-badge" id="demo-badge" style="display: none;">Demo Mode</div>

    <script src="../lib/theme-auth.js"></script>
    <script src="../lib/routines.js"></script>
    <script src="../lib/activity-bubbles.js"></script>
    <script src="../lib/theme-chat.js"></script>
    <script src="../lib/agent-drag.js"></script>
    <script src="../lib/kanban-board.js"></script>
    <script src="../lib/theme-customize.js"></script>
    <script src="onboarding.js"></script>
    <script src="../src/data-bridge.js"></script>
    <script type="module" src="medieval-scene.js"></script>
    <script type="module" src="medieval-world.js"></script>
    <script type="module" src="medieval-particles.js"></script>
    <script type="module" src="medieval-characters-v2.js"></script>
    <script type="module" src="medieval-agent-lifecycle.js"></script>
    <script type="module" src="medieval-sky.js"></script>

    <!-- â•â•â• MISSION CONTROL OVERLAY â•â•â• -->
    <div class="mc-overlay" id="missionControlOverlay">
        <div class="mc-header">
            <button class="mc-back" id="mcBack">â† Castle</button>
            <div class="mc-title">
                ğŸ‘‘ <span id="mcCeoName">ApoMac</span> â€” Royal War Room
                <span class="mc-title-badge">Commander</span>
            </div>
        </div>
        <div class="mc-body">
            <!-- Left: Missions & Quests -->
            <div class="mc-col" id="mcLeftCol"></div>
            <!-- Center: Battle Reports & Chronicles -->
            <div class="mc-col" id="mcCenterCol"></div>
            <!-- Right: Court Status -->
            <div class="mc-col" id="mcRightCol"></div>
        </div>
        <div class="mc-statusbar" id="mcStatusBar"></div>
    </div>

    <!-- â•â•â• AGENT DETAIL PANEL â•â•â• -->
    <div class="agent-detail-overlay" id="agentDetailOverlay">
        <div class="agent-detail-panel">
            <div class="agent-detail-header">
                <div class="agent-detail-avatar" id="agentDetailAvatar">âš”ï¸</div>
                <div class="agent-detail-info">
                    <h3 id="agentDetailName">Agent Name</h3>
                    <p id="agentDetailRole">Role</p>
                </div>
                <button class="agent-detail-close" id="agentDetailClose">âœ•</button>
            </div>
            <div class="agent-detail-tabs">
                <button class="agent-detail-tab active" data-tab="overview">Overview</button>
                <button class="agent-detail-tab" data-tab="thoughts">Thoughts</button>
                <button class="agent-detail-tab" data-tab="metrics">Metrics</button>
                <button class="agent-detail-tab" data-tab="sessions">Sessions</button>
            </div>
            <div class="agent-detail-content" id="agentDetailContent"></div>
            <div class="agent-detail-actions" style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border-gold);display:flex;gap:8px;">
                <button id="agentChatBtn" class="agent-action-btn" style="flex:1;padding:10px;background:var(--castle-gold);color:var(--castle-navy);border:none;border-radius:8px;font-family:var(--font-serif);font-weight:600;cursor:pointer;font-size:13px;">ğŸ’¬ Speak to Knight</button>
            </div>
        </div>
    </div>

    <!-- â•â•â• Summon Knight Modal â•â•â• -->
    <div class="agent-detail-overlay" id="summonOverlay">
        <div class="agent-detail-panel" style="max-width:460px;">
            <div class="agent-detail-header">
                <div class="agent-detail-avatar" style="background:linear-gradient(135deg,#FFD700,#B8860B);">âš”ï¸</div>
                <div class="agent-detail-info">
                    <h3 style="font-family:var(--font-medieval);">Summon a Knight</h3>
                    <p>Send a new knight on a quest</p>
                </div>
                <button class="agent-detail-close" onclick="document.getElementById('summonOverlay').style.display='none';document.getElementById('summonOverlay').classList.remove('visible');">âœ•</button>
            </div>
            <div style="margin-bottom:16px;">
                <label style="font-family:var(--font-serif);color:var(--castle-navy);font-weight:600;font-size:13px;display:block;margin-bottom:6px;">ğŸ“œ Quest Description</label>
                <textarea id="summonTask" rows="3" placeholder="Describe the quest for this knight..." style="width:100%;padding:10px;border:1px solid var(--border-gold);border-radius:8px;background:rgba(255,255,255,0.6);font-family:var(--font-serif);font-size:13px;color:var(--castle-navy);resize:vertical;box-sizing:border-box;"></textarea>
            </div>
            <div style="margin-bottom:16px;">
                <label style="font-family:var(--font-serif);color:var(--castle-navy);font-weight:600;font-size:13px;display:block;margin-bottom:6px;">âš”ï¸ Knight Class</label>
                <div id="summonModelPicker" style="display:flex;gap:8px;flex-wrap:wrap;">
                    <button class="summon-model-btn active" data-model="sonnet" style="flex:1;min-width:100px;padding:8px 12px;border:2px solid var(--border-gold);border-radius:8px;background:rgba(255,255,255,0.4);font-family:var(--font-serif);font-size:12px;cursor:pointer;color:var(--castle-navy);transition:all 0.15s;">ğŸ—¡ï¸ Squire<br><small style="opacity:0.6;">Sonnet Â· Fast</small></button>
                    <button class="summon-model-btn" data-model="opus" style="flex:1;min-width:100px;padding:8px 12px;border:2px solid var(--border-gold);border-radius:8px;background:rgba(255,255,255,0.4);font-family:var(--font-serif);font-size:12px;cursor:pointer;color:var(--castle-navy);transition:all 0.15s;">âš”ï¸ Knight<br><small style="opacity:0.6;">Opus Â· Deep</small></button>
                    <button class="summon-model-btn" data-model="gpt" style="flex:1;min-width:100px;padding:8px 12px;border:2px solid var(--border-gold);border-radius:8px;background:rgba(255,255,255,0.4);font-family:var(--font-serif);font-size:12px;cursor:pointer;color:var(--castle-navy);transition:all 0.15s;">ğŸ° Paladin<br><small style="opacity:0.6;">GPT Â· Versatile</small></button>
                </div>
            </div>
            <button id="summonBtn" style="width:100%;padding:12px;background:linear-gradient(135deg,#FFD700,#B8860B);color:var(--castle-navy);border:none;border-radius:10px;font-family:var(--font-medieval);font-size:16px;font-weight:600;cursor:pointer;letter-spacing:0.5px;box-shadow:0 4px 12px rgba(184,134,11,0.3);">âš”ï¸ Summon Knight</button>
        </div>
    </div>

    <!-- â•â•â• Summon Knight Logic â•â•â• -->
    <script>
    (function() {
        document.addEventListener('DOMContentLoaded', function() {
            // Model picker toggle
            var pickerEl = document.getElementById('summonModelPicker');
            if (pickerEl) {
                pickerEl.addEventListener('click', function(e) {
                    var btn = e.target.closest('.summon-model-btn');
                    if (!btn) return;
                    pickerEl.querySelectorAll('.summon-model-btn').forEach(function(b) { b.classList.remove('active'); });
                    btn.classList.add('active');
                });
            }

            // Summon button
            var summonBtn = document.getElementById('summonBtn');
            if (summonBtn) {
                summonBtn.addEventListener('click', function() {
                    var task = document.getElementById('summonTask').value.trim();
                    if (!task) { document.getElementById('summonTask').focus(); return; }
                    
                    var activeModel = document.querySelector('.summon-model-btn.active');
                    var model = activeModel ? activeModel.dataset.model : 'sonnet';
                    var modelMap = { sonnet: 'Sonnet', opus: 'Opus', gpt: 'GPT' };
                    
                    // Send via chat to OpenClaw
                    var message = 'Spawn a sub-agent (' + modelMap[model] + ') for this task: ' + task;
                    
                    if (window.ThemeChat && window.ThemeChat._sendMessage) {
                        window.ThemeChat._sendMessage(message);
                    } else if (window.ThemeAuth) {
                        window.ThemeAuth.fetch(window.ThemeAuth.getApiUrl() + '/api/oc/chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: message })
                        });
                    }

                    // Show progress state
                    summonBtn.textContent = 'ğŸ”® Summoning...';
                    summonBtn.style.background = '#6366f1';
                    summonBtn.disabled = true;

                    // Activity log
                    if (window.castleApp && window.castleApp.addActivityLog) {
                        window.castleApp.addActivityLog('ğŸ”® Summoning a knight for: ' + task.substring(0, 50) + '...', 'system');
                    }

                    // Poll for new sub-agent sessions (check every 3s, timeout 30s)
                    var pollCount = 0;
                    var maxPolls = 10;
                    var beforeSessions = [];
                    
                    // Snapshot current sessions
                    if (window.ThemeAuth) {
                        window.ThemeAuth.fetch(window.ThemeAuth.getApiUrl() + '/api/oc/sessions').then(function(r) {
                            return r.json();
                        }).then(function(data) {
                            var sessions = Array.isArray(data) ? data : (data.sessions || []);
                            beforeSessions = sessions.filter(function(s) { return s.kind === 'subagent'; }).map(function(s) { return s.key; });
                        }).catch(function() {});
                    }

                    var spawnPoll = setInterval(function() {
                        pollCount++;
                        if (pollCount > maxPolls) {
                            clearInterval(spawnPoll);
                            summonBtn.textContent = 'âš”ï¸ Knight dispatched!';
                            summonBtn.style.background = '#10b981';
                            setTimeout(function() {
                                var overlay = document.getElementById('summonOverlay');
                                overlay.classList.remove('visible');
                                setTimeout(function() {
                                    overlay.style.display = 'none';
                                    summonBtn.textContent = 'âš”ï¸ Summon Knight';
                                    summonBtn.style.background = 'linear-gradient(135deg,#FFD700,#B8860B)';
                                    summonBtn.disabled = false;
                                    document.getElementById('summonTask').value = '';
                                }, 300);
                            }, 1500);
                            return;
                        }

                        if (window.ThemeAuth) {
                            window.ThemeAuth.fetch(window.ThemeAuth.getApiUrl() + '/api/oc/sessions').then(function(r) {
                                return r.json();
                            }).then(function(data) {
                                var sessions = Array.isArray(data) ? data : (data.sessions || []);
                                var subs = sessions.filter(function(s) { return s.kind === 'subagent'; });
                                var newOnes = subs.filter(function(s) { return beforeSessions.indexOf(s.key) === -1; });
                                if (newOnes.length > 0) {
                                    clearInterval(spawnPoll);
                                    var knightName = newOnes[0].label || 'New Knight';
                                    summonBtn.textContent = 'âœ¨ ' + knightName + ' has arrived!';
                                    summonBtn.style.background = '#10b981';
                                    if (window.castleApp && window.castleApp.addActivityLog) {
                                        window.castleApp.addActivityLog('âš”ï¸ ' + knightName + ' has answered the summons!', 'system');
                                    }
                                    setTimeout(function() {
                                        var overlay = document.getElementById('summonOverlay');
                                        overlay.classList.remove('visible');
                                        setTimeout(function() {
                                            overlay.style.display = 'none';
                                            summonBtn.textContent = 'âš”ï¸ Summon Knight';
                                            summonBtn.style.background = 'linear-gradient(135deg,#FFD700,#B8860B)';
                                            summonBtn.disabled = false;
                                            document.getElementById('summonTask').value = '';
                                        }, 300);
                                    }, 2000);
                                }
                            }).catch(function() {});
                        }
                    }, 3000);
                });
            }

            // === Knights Roster Dropdown ===
            var knightsToggle = document.getElementById('knightsToggle');
            var knightsDD = document.getElementById('knightsDropdown');
            if (knightsToggle && knightsDD) {
                knightsToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (knightsDD.style.display === 'none') {
                        renderKnightsDropdown();
                        knightsDD.style.display = 'block';
                    } else {
                        knightsDD.style.display = 'none';
                    }
                });
                document.addEventListener('click', function(e) {
                    if (!knightsDD.contains(e.target) && !knightsToggle.contains(e.target)) {
                        knightsDD.style.display = 'none';
                    }
                });
            }

            function renderKnightsDropdown() {
                var app = window.castleApp;
                if (!app || !app.agents) return;
                var lc = window.MedievalLifecycle;
                var rows = [];

                // Collect all agents
                app.agents.forEach(function(agentData, agentId) {
                    var charData = app.characterModels ? app.characterModels.get(agentId) : null;
                    var state = lc ? lc.getAgentState(agentId) : null;
                    var isActive = agentData.status === 'active' || (charData && !state?.isDecommissioning);
                    rows.push({
                        id: agentId,
                        name: agentId,
                        role: agentData.role || 'Knight',
                        char: agentData.char || null,
                        color: agentData.color || '#555',
                        active: isActive,
                        emoji: state?.currentEmoji || '',
                        mood: state?.moodLabel || 'neutral',
                        selected: agentId === app.selectedAgent
                    });
                });

                // Sort: active first, then alphabetical
                rows.sort(function(a, b) {
                    if (a.active !== b.active) return a.active ? -1 : 1;
                    return a.name.localeCompare(b.name);
                });

                var activeRows = rows.filter(function(r) { return r.active; });
                var idleRows = rows.filter(function(r) { return !r.active; });

                var html = '';
                if (activeRows.length) {
                    html += '<div class="kr-section">âš”ï¸ Active (' + activeRows.length + ')</div>';
                    activeRows.forEach(function(r) { html += knightRow(r); });
                }
                if (idleRows.length) {
                    html += '<div class="kr-section">ğŸ’¤ Resting (' + idleRows.length + ')</div>';
                    idleRows.forEach(function(r) { html += knightRow(r); });
                }
                if (!rows.length) {
                    html = '<div style="padding:20px;text-align:center;color:var(--castle-brown);font-size:13px;">No knights in the realm</div>';
                }

                knightsDD.innerHTML = html;

                // Wire click handlers
                knightsDD.querySelectorAll('.kr-row').forEach(function(row) {
                    row.addEventListener('click', function() {
                        var id = row.dataset.agent;
                        knightsDD.style.display = 'none';
                        if (app.selectAgent) app.selectAgent(id);
                    });
                });
            }

            function knightRow(r) {
                var avatarInner = r.char
                    ? '<img src="assets/characters/character-' + r.char + '.png" alt="' + r.name + '">'
                    : r.name.slice(0, 2);
                return '<div class="kr-row' + (r.selected ? ' kr-selected' : '') + '" data-agent="' + r.id + '">'
                    + '<div class="kr-avatar" style="background:' + r.color + ';">' + avatarInner + '</div>'
                    + '<div class="kr-info"><div class="kr-name">' + r.name + '</div><div class="kr-role">' + r.role + '</div></div>'
                    + '<div class="kr-right"><span class="kr-emoji">' + r.emoji + '</span><div class="kr-status ' + (r.active ? 'active' : 'idle') + '"></div></div>'
                    + '</div>';
            }

            // Close summon overlay on backdrop click
            var summonOverlay = document.getElementById('summonOverlay');
            if (summonOverlay) {
                summonOverlay.addEventListener('click', function(e) {
                    if (e.target === summonOverlay) {
                        summonOverlay.classList.remove('visible');
                        setTimeout(function() { summonOverlay.style.display = 'none'; }, 300);
                    }
                });
            }
        });
    })();
    </script>

    <!-- â•â•â• MODULAR JS â•â•â• -->
    <script src="medieval-mission-control.js"></script>
    <script src="medieval-integration.js"></script>

    <!-- Roblox-style Hotbar -->
    <div id="roblox-hotbar" style="position:fixed;bottom:16px;left:50%;transform:translateX(-50%);display:flex;gap:4px;z-index:100;pointer-events:auto;"></div>
    <script src="medieval-panels.js"></script>
    <script src="medieval-hotbar.js"></script>
    <script src="medieval-audio.js"></script>
    <script src="channel-onboarding.js"></script>

    <!-- â•â•â• Theme Switcher Modal â•â•â• -->
    <div class="agent-detail-overlay" id="themeSwitcherOverlay">
        <div class="agent-detail-panel" style="max-width:520px;">
            <div class="agent-detail-header">
                <div class="agent-detail-avatar" style="background:linear-gradient(135deg,#1a1a2e,#16213e);">ğŸ¨</div>
                <div class="agent-detail-info">
                    <h3 style="font-family:var(--font-medieval);">Choose Your Realm</h3>
                    <p>Switch to another SpawnKit theme</p>
                </div>
                <button class="agent-detail-close" onclick="document.getElementById('themeSwitcherOverlay').style.display='none';document.getElementById('themeSwitcherOverlay').classList.remove('visible');">âœ•</button>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:4px;" id="themeGrid">
                <div class="theme-card" onclick="window.location.href='/office-medieval/'" style="border:2px solid var(--castle-gold);">
                    <div class="theme-card-icon">ğŸ°</div>
                    <div class="theme-card-name">Medieval Castle</div>
                    <div class="theme-card-desc">Current realm</div>
                    <div class="theme-card-badge" style="background:var(--castle-gold);color:var(--castle-navy);">Active</div>
                </div>
                <div class="theme-card" onclick="window.location.href='/office-executive/'">
                    <div class="theme-card-icon">ğŸ¢</div>
                    <div class="theme-card-name">Executive Office</div>
                    <div class="theme-card-desc">Modern corporate HQ</div>
                </div>
                <div class="theme-card" onclick="window.location.href='/office-simcity-nature/'">
                    <div class="theme-card-icon">ğŸŒ³</div>
                    <div class="theme-card-name">SimCity Village</div>
                    <div class="theme-card-desc">Pixel city life</div>
                </div>
                <div class="theme-card" style="opacity:0.5;cursor:not-allowed;">
                    <div class="theme-card-icon">ğŸ•¹ï¸</div>
                    <div class="theme-card-name">GameBoy</div>
                    <div class="theme-card-desc">Coming soon</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Building Contextual Panel -->
    <div id="building-panel" class="building-panel">
        <div class="building-panel-header">
            <span id="building-panel-icon"></span>
            <span id="building-panel-title"></span>
            <button class="panel-close-btn" onclick="closeBuildingPanel()">âœ•</button>
        </div>
        <div id="building-panel-content" class="building-panel-content"></div>
    </div>
</body>
</html>
